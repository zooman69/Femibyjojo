<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Femi By Jojo - Inventory Manager with Wix Sync</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .wix-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            margin-top: 10px;
            cursor: pointer;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-dot.connected {
            background: #28a745;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: rgba(255,255,255,0.2);
            padding: 15px 25px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        select, button {
            padding: 12px 20px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: bold;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.wix-sync {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        button.wix-sync:hover {
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
        }

        .file-upload {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .file-label:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            position: sticky;
            top: 0;
            background: #343a40;
            color: white;
            z-index: 10;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:hover {
            background: #495057;
        }

        th.sortable::after {
            content: ' ⇅';
            opacity: 0.3;
        }

        th.sorted-asc::after {
            content: ' ↑';
            opacity: 1;
        }

        th.sorted-desc::after {
            content: ' ↓';
            opacity: 1;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #dee2e6;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody tr.syncing {
            opacity: 0.6;
        }

        .product-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
        }

        .visible-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .visible-true {
            background: #d4edda;
            color: #155724;
        }

        .visible-false {
            background: #f8d7da;
            color: #721c24;
        }

        .sync-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }

        .sync-status.synced {
            background: #d4edda;
            color: #155724;
        }

        .sync-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .sync-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .sync-status.syncing {
            background: #cfe2ff;
            color: #084298;
        }

        .price {
            font-weight: bold;
            color: #28a745;
        }

        .edit-btn, .delete-btn, .sync-btn {
            padding: 6px 12px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .edit-btn {
            background: #007bff;
            color: white;
        }

        .edit-btn:hover {
            background: #0056b3;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .sync-btn {
            background: #ff6b6b;
            color: white;
        }

        .sync-btn:hover {
            background: #ee5a6f;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 20px;
            background: #f8f9fa;
        }

        .pagination button {
            padding: 8px 16px;
            min-width: 40px;
        }

        .pagination .page-info {
            font-size: 14px;
            color: #495057;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            width: 100%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            color: #343a40;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 40px;
            height: 40px;
        }

        .close-btn:hover {
            color: #dc3545;
            transform: none;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: #b8c5d6;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.6;
        }

        .form-group small {
            display: block;
            margin-top: 6px;
            font-size: 12px;
            color: #6c757d;
            font-style: italic;
        }

        /* Form sections */
        .form-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .form-section-title {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-section-title::before {
            content: "▶";
            font-size: 12px;
        }

        /* Two column layout for form */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-grid-full {
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Enhanced file input button */
        .form-group input[type="file"] + label,
        .form-group button[type="button"] {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(155, 89, 182, 0.3);
        }

        .form-group input[type="file"] + label:hover,
        .form-group button[type="button"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(155, 89, 182, 0.4);
        }

        /* Number input styling */
        .form-group input[type="number"] {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 2px solid #e9ecef;
        }

        .form-actions button {
            padding: 12px 30px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .form-actions button[type="submit"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .form-actions button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        .form-actions button[type="button"] {
            background: white;
            border: 2px solid #dee2e6;
            color: #495057;
        }

        .form-actions button[type="button"]:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
        }

        .sync-log {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .log-entry.success {
            color: #28a745;
        }

        .log-entry.error {
            color: #dc3545;
        }

        .log-entry.info {
            color: #007bff;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-left: 4px solid #28a745;
        }

        .notification.error {
            border-left: 4px solid #dc3545;
        }

        .notification.info {
            border-left: 4px solid #007bff;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .control-row {
                flex-direction: column;
            }

            .search-box {
                min-width: 100%;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Femi By Jojo - Inventory Manager</h1>
            <div class="wix-status" onclick="openWixSettings()">
                <span class="status-dot" id="wixStatusDot"></span>
                <span id="wixStatusText">Wix: Not Connected</span>
            </div>
            <div class="stats">
                <div class="stat-card">
                    <div class="number" id="totalProducts">0</div>
                    <div class="label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="visibleProducts">0</div>
                    <div class="label">Visible Products</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="totalValue">$0</div>
                    <div class="label">Total Inventory Value</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="lastSync">Never</div>
                    <div class="label">Last Sync</div>
                </div>
            </div>
        </header>

        <div class="controls">
            <div class="control-row">
                <div class="file-upload">
                    <input type="file" id="csvFile" accept=".csv">
                    <label for="csvFile" class="file-label">Load CSV File</label>
                    <span id="fileName"></span>
                </div>
                <button class="wix-sync" onclick="importFromWix()" id="importWixBtn">Import from Wix</button>
                <button onclick="exportToCSV()">Export to CSV</button>
                <button onclick="addNewProduct()">Add New Product</button>
                <button class="wix-sync" onclick="syncAllToWix()" id="syncAllBtn">Sync All to Wix</button>
                <button class="wix-sync" onclick="syncSelectedToWix()" id="syncSelectedBtn">Sync Selected</button>
            </div>
            <div class="control-row">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search by name, SKU, category..." oninput="filterTable()">
                </div>
                <select id="collectionFilter" onchange="filterTable()">
                    <option value="">All Categories</option>
                </select>
                <select id="visibilityFilter" onchange="filterTable()">
                    <option value="">All Visibility</option>
                    <option value="TRUE">Visible Only</option>
                    <option value="FALSE">Hidden Only</option>
                </select>
                <select id="itemsPerPage" onchange="changeItemsPerPage()">
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                    <option value="all">Show All</option>
                </select>
            </div>
        </div>

        <div class="table-container">
            <table id="inventoryTable">
                <thead>
                    <tr id="tableHeader"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="pagination" id="pagination"></div>
    </div>

    <!-- Wix Settings Modal -->
    <div class="modal" id="wixSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Wix API Settings</h2>
                <button class="close-btn" onclick="closeWixSettings()">&times;</button>
            </div>
            <div class="form-group">
                <label>Wix Site ID</label>
                <input type="text" id="wixSiteId" placeholder="e.g., 12345678-abcd-1234-abcd-123456789abc">
                <small style="display: block; margin-top: 5px; color: #6c757d;">
                    Find this in your Wix Dashboard → Settings → Business Info
                </small>
            </div>
            <div class="form-group">
                <label>API Key</label>
                <input type="password" id="wixApiKey" placeholder="Your Wix API Key">
                <small style="display: block; margin-top: 5px; color: #6c757d;">
                    Get this from Wix Developers → API Keys
                </small>
            </div>
            <div class="form-group">
                <label>Account ID</label>
                <input type="text" id="wixAccountId" placeholder="Your Wix Account ID">
            </div>
            <div class="form-actions">
                <button type="button" onclick="closeWixSettings()" style="background: #6c757d;">Cancel</button>
                <button type="button" onclick="testWixConnection()">Test Connection</button>
                <button type="button" onclick="saveWixSettings()">Save Settings</button>
            </div>
            <div id="connectionLog" class="sync-log" style="margin-top: 20px; display: none;"></div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Edit Product</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="editForm">
                <div id="formFields"></div>
                <div class="form-actions">
                    <button type="button" onclick="closeModal()" style="background: #6c757d;">Cancel</button>
                    <button type="submit">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        let allProducts = [];
        let filteredProducts = [];
        let currentPage = 1;
        let itemsPerPage = 25;
        let sortColumn = null;
        let sortDirection = 'asc';
        let currentEditIndex = null;
        let headers = [];
        let selectedProducts = new Set();
        let wixConfig = {
            siteId: '',
            apiKey: '',
            accountId: '',
            connected: false
        };

        // API proxy URL - set this to your Vercel deployment URL
        const API_PROXY_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000/api/wix-proxy'
            : 'https://femibyjojo.vercel.app/api/wix-proxy';

        // Helper function to call Wix API through proxy
        async function callWixAPI(endpoint, method = 'GET', body = null) {
            const response = await fetch(API_PROXY_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    endpoint: endpoint,
                    method: method,
                    body: body,
                    headers: {
                        'authorization': wixConfig.apiKey,
                        'wix-site-id': wixConfig.siteId,
                        'wix-account-id': wixConfig.accountId
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || error.message || 'API request failed');
            }

            return await response.json();
        }

        // Load Wix config from localStorage
        function loadWixConfig() {
            const saved = localStorage.getItem('wixConfig');
            if (saved) {
                wixConfig = JSON.parse(saved);
                updateWixStatus();
            }
        }

        // Save Wix config to localStorage
        function saveWixConfig() {
            localStorage.setItem('wixConfig', JSON.stringify(wixConfig));
        }

        // Update Wix status display
        function updateWixStatus() {
            const dot = document.getElementById('wixStatusDot');
            const text = document.getElementById('wixStatusText');

            if (wixConfig.connected && wixConfig.siteId && wixConfig.apiKey) {
                dot.classList.add('connected');
                text.textContent = 'Wix: Connected';
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Wix: Not Connected';
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Open Wix settings
        function openWixSettings() {
            document.getElementById('wixSiteId').value = wixConfig.siteId || '';
            document.getElementById('wixApiKey').value = wixConfig.apiKey || '';
            document.getElementById('wixAccountId').value = wixConfig.accountId || '';
            document.getElementById('wixSettingsModal').classList.add('active');
        }

        // Close Wix settings
        function closeWixSettings() {
            document.getElementById('wixSettingsModal').classList.remove('active');
            document.getElementById('connectionLog').style.display = 'none';
        }

        // Test Wix connection
        async function testWixConnection() {
            const siteId = document.getElementById('wixSiteId').value.trim();
            const apiKey = document.getElementById('wixApiKey').value.trim();
            const accountId = document.getElementById('wixAccountId').value.trim();

            const log = document.getElementById('connectionLog');
            log.style.display = 'block';
            log.innerHTML = '<div class="log-entry info">Testing connection...</div>';

            if (!siteId || !apiKey || !accountId) {
                log.innerHTML += '<div class="log-entry error">Error: All fields are required</div>';
                return;
            }

            try {
                // Store credentials temporarily for test
                const tempConfig = {...wixConfig};
                wixConfig.siteId = siteId;
                wixConfig.apiKey = apiKey;
                wixConfig.accountId = accountId;

                // Test API connection through proxy
                const data = await callWixAPI('/stores/v1/products/query', 'POST', {
                    query: {
                        paging: { limit: 1 }
                    }
                });

                log.innerHTML += '<div class="log-entry success">✓ Connection successful!</div>';
                log.innerHTML += `<div class="log-entry info">Found ${data.totalResults || 0} products in your store</div>`;
                showNotification('Wix connection successful!', 'success');

                // Restore original config (will be saved when user clicks Save)
                wixConfig = tempConfig;
            } catch (error) {
                log.innerHTML += `<div class="log-entry error">✗ Connection error: ${error.message}</div>`;
                showNotification('Connection error: ' + error.message, 'error');
            }
        }

        // Save Wix settings
        function saveWixSettings() {
            wixConfig.siteId = document.getElementById('wixSiteId').value.trim();
            wixConfig.apiKey = document.getElementById('wixApiKey').value.trim();
            wixConfig.accountId = document.getElementById('wixAccountId').value.trim();
            wixConfig.connected = !!(wixConfig.siteId && wixConfig.apiKey && wixConfig.accountId);

            saveWixConfig();
            updateWixStatus();
            closeWixSettings();
            showNotification('Wix settings saved!', 'success');
        }

        // Upload image to Wix
        async function uploadImageToWix(file) {
            if (!file) return null;

            try {
                // Convert file to base64
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                // Upload to Wix Media Manager
                const uploadResult = await callWixAPI('/site-media/v1/files', 'POST', {
                    file: {
                        displayName: file.name,
                        mimeType: file.type,
                        url: `data:${file.type};base64,${base64}`
                    }
                });

                if (uploadResult && uploadResult.file && uploadResult.file.id) {
                    return uploadResult.file.id;
                }

                return null;
            } catch (error) {
                console.error('Image upload error:', error);
                throw new Error(`Failed to upload image: ${error.message}`);
            }
        }

        // Sync product to Wix
        async function syncProductToWix(product, index) {
            if (!wixConfig.connected) {
                showNotification('Please configure Wix API settings first', 'error');
                openWixSettings();
                return false;
            }

            try {
                // Upload image if a file was selected
                if (currentImageFile && index === currentEditIndex) {
                    showNotification('Uploading image...', 'info');
                    const imageId = await uploadImageToWix(currentImageFile);
                    if (imageId) {
                        product.productImageUrl = imageId;
                        currentImageFile = null;
                    }
                }

                // Map CSV product to Wix product format
                const wixProduct = {
                    name: product.name,
                    productType: 'physical',
                    priceData: {
                        price: parseFloat(product.price) || 0,
                        currency: 'USD'
                    },
                    stock: {
                        trackInventory: true,
                        quantity: parseInt(product.inventory) || 0
                    },
                    visible: product.visible === 'TRUE',
                    ribbon: product.ribbon || '',
                    description: product.description || ''
                };

                // Add discount if available
                if (product.discountValue && parseFloat(product.discountValue) > 0) {
                    const discountValue = parseFloat(product.discountValue);
                    if (product.discountMode === 'PERCENT') {
                        wixProduct.discount = {
                            type: 'PERCENT',
                            value: discountValue
                        };
                    } else {
                        wixProduct.discount = {
                            type: 'AMOUNT',
                            value: discountValue
                        };
                    }
                    console.log(`Setting discount: ${product.discountMode} ${discountValue}`);
                }

                // Add SKU if available
                if (product.sku) {
                    wixProduct.sku = product.sku;
                }

                // Add collection if available - handle both collection names and IDs
                if (product.collection) {
                    // If collection looks like an ID (UUID format), use it directly
                    // Otherwise, try to find collection by name or create it
                    if (product.collection.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)) {
                        wixProduct.collectionIds = [product.collection];
                    } else {
                        // Search for collection by name
                        try {
                            const collectionsResponse = await callWixAPI('/stores/v1/collections/query', 'POST', {
                                query: {
                                    filter: JSON.stringify({ name: product.collection })
                                }
                            });

                            if (collectionsResponse.collections && collectionsResponse.collections.length > 0) {
                                wixProduct.collectionIds = [collectionsResponse.collections[0].id];
                            } else {
                                // Create new collection if it doesn't exist
                                const newCollection = await callWixAPI('/stores/v1/collections', 'POST', {
                                    collection: {
                                        name: product.collection,
                                        visible: true
                                    }
                                });
                                if (newCollection.collection && newCollection.collection.id) {
                                    wixProduct.collectionIds = [newCollection.collection.id];
                                    console.log(`Created new category: ${product.collection} (${newCollection.collection.id})`);
                                }
                            }
                        } catch (error) {
                            console.error('Category handling error:', error);
                            // Continue without category if there's an error
                        }
                    }
                }

                // Add cost if available
                if (product.cost) {
                    wixProduct.costAndProfitData = {
                        itemCost: parseFloat(product.cost) || 0
                    };
                }

                // Add weight if available
                if (product.weight) {
                    wixProduct.weight = parseFloat(product.weight) || 0;
                }

                // Add product image if available
                if (product.productImageUrl) {
                    wixProduct.media = {
                        mainMedia: {
                            image: {
                                url: product.productImageUrl.startsWith('http')
                                    ? product.productImageUrl
                                    : `wix:image://v1/${product.productImageUrl}`
                            }
                        }
                    };
                }

                // Find existing product - check handleId first (contains Wix product ID), then SKU
                let productId = null;

                // Method 1: Check if handleId contains a Wix product ID (starts with alphanumeric pattern)
                if (product.handleId && !product.handleId.startsWith('product_') && product.handleId.length > 10) {
                    // handleId is likely a Wix product ID, verify it exists
                    try {
                        const existingProduct = await callWixAPI(`/stores/v1/products/${product.handleId}`, 'GET');
                        if (existingProduct && existingProduct.product) {
                            productId = product.handleId;
                            console.log(`Found existing product by ID: ${product.name} (${productId})`);
                        }
                    } catch (error) {
                        // Product ID not found, will try SKU search or create new
                        console.log(`Product ID ${product.handleId} not found, searching by SKU...`);
                    }
                }

                // Method 2: If not found by ID, search by SKU
                if (!productId && product.sku) {
                    const searchData = await callWixAPI('/stores/v1/products/query', 'POST', {
                        query: {
                            filter: JSON.stringify({ sku: product.sku })
                        }
                    });

                    if (searchData.products && searchData.products.length > 0) {
                        productId = searchData.products[0].id;
                        console.log(`Found existing product by SKU: ${product.name} (${productId})`);
                    }
                }

                // Update or create product
                if (productId) {
                    // Update existing product
                    console.log(`Updating product: ${product.name}`);
                    await callWixAPI(`/stores/v1/products/${productId}`, 'PATCH', { product: wixProduct });
                } else {
                    // Create new product
                    console.log(`Creating new product: ${product.name}`);
                    const result = await callWixAPI('/stores/v1/products', 'POST', { product: wixProduct });
                    // Update handleId with the new Wix product ID for future syncs
                    if (result.product && result.product.id) {
                        product.handleId = result.product.id;
                    }
                }

                product.syncStatus = 'synced';
                product.lastSyncTime = new Date().toISOString();
                return true;
            } catch (error) {
                console.error('Sync error:', error);
                product.syncStatus = 'error';
                product.syncError = error.message;
                return false;
            }
        }

        // Sync all products to Wix
        async function syncAllToWix() {
            if (!wixConfig.connected) {
                showNotification('Please configure Wix API settings first', 'error');
                openWixSettings();
                return;
            }

            if (!confirm(`Are you sure you want to sync all ${allProducts.length} products to Wix?`)) {
                return;
            }

            const btn = document.getElementById('syncAllBtn');
            btn.disabled = true;
            btn.textContent = 'Syncing...';

            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < allProducts.length; i++) {
                const product = allProducts[i];
                product.syncStatus = 'syncing';
                renderTable();

                const success = await syncProductToWix(product, i);
                if (success) {
                    successCount++;
                } else {
                    errorCount++;
                }

                renderTable();
            }

            btn.disabled = false;
            btn.textContent = 'Sync All to Wix';

            document.getElementById('lastSync').textContent = new Date().toLocaleTimeString();
            showNotification(`Sync complete: ${successCount} succeeded, ${errorCount} failed`, errorCount > 0 ? 'error' : 'success');
        }

        // Sync selected products
        async function syncSelectedToWix() {
            if (selectedProducts.size === 0) {
                showNotification('No products selected', 'info');
                return;
            }

            if (!wixConfig.connected) {
                showNotification('Please configure Wix API settings first', 'error');
                openWixSettings();
                return;
            }

            const btn = document.getElementById('syncSelectedBtn');
            btn.disabled = true;
            btn.textContent = 'Syncing...';

            let successCount = 0;
            let errorCount = 0;

            for (const index of selectedProducts) {
                const product = allProducts[index];
                product.syncStatus = 'syncing';
                renderTable();

                const success = await syncProductToWix(product, index);
                if (success) {
                    successCount++;
                } else {
                    errorCount++;
                }

                renderTable();
            }

            btn.disabled = false;
            btn.textContent = 'Sync Selected';

            document.getElementById('lastSync').textContent = new Date().toLocaleTimeString();
            showNotification(`Sync complete: ${successCount} succeeded, ${errorCount} failed`, errorCount > 0 ? 'error' : 'success');
        }

        // Toggle product selection
        function toggleProductSelection(index, checkbox) {
            if (checkbox.checked) {
                selectedProducts.add(index);
            } else {
                selectedProducts.delete(index);
            }
        }

        // Load CSV file
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseCSV(e.target.result);
                };
                reader.readAsText(file);
            }
        });

        // Parse CSV data
        function parseCSV(csv) {
            const lines = csv.split('\n');
            if (lines.length === 0) return;

            const firstLine = lines[0].replace(/^\ufeff/, '');
            headers = firstLine.split(',').map(h => h.trim());

            allProducts = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;

                const values = parseCSVLine(lines[i]);
                if (values.length > 0) {
                    const product = {};
                    headers.forEach((header, index) => {
                        product[header] = values[index] || '';
                    });
                    product.syncStatus = 'pending';
                    allProducts.push(product);
                }
            }

            populateFilters();
            filterTable();
            updateStats();
            renderTable();
            showNotification(`Loaded ${allProducts.length} products`, 'success');
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim());
            return values;
        }

        function populateFilters() {
            const collections = new Set();
            allProducts.forEach(product => {
                if (product.collection) {
                    collections.add(product.collection);
                }
            });

            const collectionFilter = document.getElementById('collectionFilter');
            collectionFilter.innerHTML = '<option value="">All Categories</option>';
            Array.from(collections).sort().forEach(collection => {
                const option = document.createElement('option');
                option.value = collection;
                option.textContent = collection;
                collectionFilter.appendChild(option);
            });
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const collectionFilter = document.getElementById('collectionFilter').value;
            const visibilityFilter = document.getElementById('visibilityFilter').value;

            filteredProducts = allProducts.filter(product => {
                const matchesSearch = !searchTerm ||
                    (product.name && product.name.toLowerCase().includes(searchTerm)) ||
                    (product.sku && product.sku.toLowerCase().includes(searchTerm)) ||
                    (product.collection && product.collection.toLowerCase().includes(searchTerm));

                const matchesCollection = !collectionFilter || product.collection === collectionFilter;
                const matchesVisibility = !visibilityFilter || product.visible === visibilityFilter;

                return matchesSearch && matchesCollection && matchesVisibility;
            });

            currentPage = 1;
            renderTable();
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            filteredProducts.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';

                if (column === 'price' || column === 'cost' || column === 'inventory' || column === 'weight') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            renderTable();
        }

        function renderTable() {
            if (allProducts.length === 0) {
                document.getElementById('tableHeader').innerHTML = '';
                document.getElementById('tableBody').innerHTML = `
                    <tr><td colspan="100" class="empty-state">
                        <h3>No products loaded</h3>
                        <p>Please load a CSV file to begin managing your inventory</p>
                    </td></tr>
                `;
                return;
            }

            const headerRow = document.getElementById('tableHeader');
            const displayColumns = ['select', 'productImageUrl', 'name', 'collection', 'sku', 'price', 'discountValue', 'salePrice', 'inventory', 'visible', 'syncStatus', 'actions'];
            const columnLabels = {
                'select': '☑',
                'productImageUrl': 'Image',
                'name': 'Product Name',
                'collection': 'Category',
                'sku': 'SKU',
                'price': 'Price',
                'discountValue': 'Discount',
                'salePrice': 'Sale Price',
                'inventory': 'Stock',
                'visible': 'Status',
                'syncStatus': 'Sync',
                'actions': 'Actions'
            };

            headerRow.innerHTML = displayColumns.map(col => {
                if (col === 'actions' || col === 'select' || col === 'syncStatus') {
                    return `<th>${columnLabels[col]}</th>`;
                }
                const sorted = sortColumn === col ? (sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc') : '';
                return `<th class="sortable ${sorted}" onclick="sortTable('${col}')">${columnLabels[col]}</th>`;
            }).join('');

            const start = itemsPerPage === 'all' ? 0 : (currentPage - 1) * itemsPerPage;
            const end = itemsPerPage === 'all' ? filteredProducts.length : start + itemsPerPage;
            const paginatedProducts = filteredProducts.slice(start, end);

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = paginatedProducts.map((product, index) => {
                const actualIndex = allProducts.indexOf(product);
                const imageUrl = product.productImageUrl ?
                    `https://static.wixstatic.com/media/${product.productImageUrl}` : '';

                const syncStatusClass = product.syncStatus || 'pending';
                const syncStatusText = {
                    'pending': 'Pending',
                    'syncing': 'Syncing...',
                    'synced': 'Synced',
                    'error': 'Error'
                }[syncStatusClass] || 'Unknown';

                // Format discount display and calculate sale price
                let discountDisplay = '-';
                let salePriceDisplay = '-';
                const basePrice = parseFloat(product.price || 0);

                if (product.discountValue && parseFloat(product.discountValue) > 0) {
                    const discountVal = parseFloat(product.discountValue);
                    let salePrice = basePrice;

                    if (product.discountMode === 'PERCENT') {
                        discountDisplay = `${discountVal}%`;
                        salePrice = basePrice - (basePrice * (discountVal / 100));
                    } else {
                        discountDisplay = `$${discountVal.toFixed(2)}`;
                        salePrice = basePrice - discountVal;
                    }

                    salePriceDisplay = `$${Math.max(0, salePrice).toFixed(2)}`;
                }

                return `
                    <tr class="${product.syncStatus === 'syncing' ? 'syncing' : ''}">
                        <td><input type="checkbox" onchange="toggleProductSelection(${actualIndex}, this)" ${selectedProducts.has(actualIndex) ? 'checked' : ''}></td>
                        <td>
                            ${imageUrl ? `<img src="${imageUrl}" class="product-image" alt="${product.name}" onclick="window.open('${imageUrl}', '_blank')">` : '-'}
                        </td>
                        <td><strong>${product.name || '-'}</strong></td>
                        <td>${product.collection || '-'}</td>
                        <td>${product.sku || '-'}</td>
                        <td class="price">$${basePrice.toFixed(2)}</td>
                        <td style="color: #e74c3c; font-weight: 500;">${discountDisplay}</td>
                        <td style="color: #27ae60; font-weight: 600; font-size: 1.05em;">${salePriceDisplay}</td>
                        <td>${product.inventory || 0}</td>
                        <td><span class="visible-badge visible-${product.visible?.toLowerCase()}">${product.visible === 'TRUE' ? 'Visible' : 'Hidden'}</span></td>
                        <td><span class="sync-status ${syncStatusClass}">${syncStatusText}</span></td>
                        <td>
                            <button class="edit-btn" onclick="editProduct(${actualIndex})">Edit</button>
                            <button class="sync-btn" onclick="syncSingleProduct(${actualIndex})">Sync</button>
                            <button class="delete-btn" onclick="deleteProduct(${actualIndex})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination();
        }

        function renderPagination() {
            if (itemsPerPage === 'all') {
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            const pagination = document.getElementById('pagination');

            pagination.innerHTML = `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                <span class="page-info">Page ${currentPage} of ${totalPages} (${filteredProducts.length} products)</span>
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
            `;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTable();
        }

        function changeItemsPerPage() {
            const value = document.getElementById('itemsPerPage').value;
            itemsPerPage = value === 'all' ? 'all' : parseInt(value);
            currentPage = 1;
            renderTable();
        }

        function updateStats() {
            document.getElementById('totalProducts').textContent = allProducts.length;

            const visibleCount = allProducts.filter(p => p.visible === 'TRUE').length;
            document.getElementById('visibleProducts').textContent = visibleCount;

            const totalValue = allProducts.reduce((sum, p) => {
                const price = parseFloat(p.price || 0);
                const inventory = parseInt(p.inventory || 0);
                return sum + (price * inventory);
            }, 0);
            document.getElementById('totalValue').textContent = '$' + totalValue.toFixed(2);
        }

        function editProduct(index) {
            currentEditIndex = index;
            currentImageFile = null;
            const product = allProducts[index];

            document.getElementById('modalTitle').textContent = 'Edit Product';

            const formFields = document.getElementById('formFields');
            const value = (field) => product[field] || '';

            formFields.innerHTML = `
                <div class="form-section">
                    <div class="form-section-title">Basic Information</div>
                    <div class="form-grid">
                        <div class="form-group form-grid-full">
                            <label>Product Name</label>
                            <input type="text" name="name" value="${value('name')}" placeholder="Enter product name" required>
                        </div>
                        <div class="form-group">
                            <label>SKU</label>
                            <input type="text" name="sku" value="${value('sku')}" placeholder="Product SKU">
                        </div>
                        <div class="form-group">
                            <label>Brand</label>
                            <input type="text" name="brand" value="${value('brand')}" placeholder="Brand name">
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <input type="text" name="collection" value="${value('collection')}" placeholder="Product category">
                        </div>
                        <div class="form-group">
                            <label>Ribbon</label>
                            <input type="text" name="ribbon" value="${value('ribbon')}" placeholder="e.g., New, Sale, Best Seller">
                            <small>Optional badge to display on product</small>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">Product Image</div>
                    <div class="form-group">
                        <label>Image</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" name="productImageUrl" id="imageUrlInput" value="${value('productImageUrl')}" placeholder="Image URL or filename" style="flex: 1;">
                            <input type="file" id="imageFileInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                            <button type="button" onclick="document.getElementById('imageFileInput').click()">
                                📁 Choose Image
                            </button>
                        </div>
                        <small>Upload an image or enter a Wix media URL</small>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">Pricing & Inventory</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Price ($)</label>
                            <input type="number" name="price" value="${value('price')}" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label>Cost ($)</label>
                            <input type="number" name="cost" value="${value('cost')}" step="0.01" min="0" placeholder="0.00">
                            <small>Your cost for this item</small>
                        </div>
                        <div class="form-group">
                            <label>Discount Type</label>
                            <select name="discountMode">
                                <option value="AMOUNT" ${value('discountMode') === 'AMOUNT' || !value('discountMode') ? 'selected' : ''}>💵 Fixed Amount ($)</option>
                                <option value="PERCENT" ${value('discountMode') === 'PERCENT' ? 'selected' : ''}>📊 Percentage (%)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Discount Value</label>
                            <input type="number" name="discountValue" value="${value('discountValue')}" step="0.01" min="0" placeholder="0.00">
                            <small>Leave empty for no discount</small>
                        </div>
                        <div class="form-group">
                            <label>Stock Quantity</label>
                            <input type="number" name="inventory" value="${value('inventory')}" step="1" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Weight (lbs)</label>
                            <input type="number" name="weight" value="${value('weight')}" step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">Visibility</div>
                    <div class="form-group">
                        <label>Product Status</label>
                        <select name="visible">
                            <option value="TRUE" ${value('visible') === 'TRUE' ? 'selected' : ''}>✅ Visible (Show on store)</option>
                            <option value="FALSE" ${value('visible') === 'FALSE' ? 'selected' : ''}>🔒 Hidden (Not visible to customers)</option>
                        </select>
                    </div>
                </div>
            `;

            document.getElementById('editModal').classList.add('active');
        }

        let currentImageFile = null;

        function addNewProduct() {
            currentEditIndex = -1;
            currentImageFile = null;
            document.getElementById('modalTitle').textContent = 'Add New Product';

            const newProduct = {
                handleId: `product_${Date.now()}`,
                fieldType: 'Product',
                name: '',
                productImageUrl: '',
                collection: '',
                sku: '',
                price: '',
                discountMode: 'AMOUNT',
                discountValue: '',
                cost: '',
                inventory: '0',
                visible: 'TRUE',
                ribbon: '',
                weight: '',
                brand: 'Femi By Jojo'
            };

            const formFields = document.getElementById('formFields');
            const value = (field) => newProduct[field] || '';

            formFields.innerHTML = `
                <input type="hidden" name="handleId" value="${newProduct.handleId}">
                <input type="hidden" name="fieldType" value="${newProduct.fieldType}">

                <div class="form-section">
                    <div class="form-section-title">Basic Information</div>
                    <div class="form-grid">
                        <div class="form-group form-grid-full">
                            <label>Product Name</label>
                            <input type="text" name="name" value="" placeholder="Enter product name" required>
                        </div>
                        <div class="form-group">
                            <label>SKU</label>
                            <input type="text" name="sku" value="" placeholder="Product SKU">
                        </div>
                        <div class="form-group">
                            <label>Brand</label>
                            <input type="text" name="brand" value="${value('brand')}" placeholder="Brand name">
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <input type="text" name="collection" value="" placeholder="Product category">
                        </div>
                        <div class="form-group">
                            <label>Ribbon</label>
                            <input type="text" name="ribbon" value="" placeholder="e.g., New, Sale, Best Seller">
                            <small>Optional badge to display on product</small>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">Product Image</div>
                    <div class="form-group">
                        <label>Image</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" name="productImageUrl" id="imageUrlInput" value="" placeholder="Image URL or filename" style="flex: 1;">
                            <input type="file" id="imageFileInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                            <button type="button" onclick="document.getElementById('imageFileInput').click()">
                                📁 Choose Image
                            </button>
                        </div>
                        <small>Upload an image or enter a Wix media URL</small>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">Pricing & Inventory</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Price ($)</label>
                            <input type="number" name="price" value="" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label>Cost ($)</label>
                            <input type="number" name="cost" value="" step="0.01" min="0" placeholder="0.00">
                            <small>Your cost for this item</small>
                        </div>
                        <div class="form-group">
                            <label>Discount Type</label>
                            <select name="discountMode">
                                <option value="AMOUNT" selected>💵 Fixed Amount ($)</option>
                                <option value="PERCENT">📊 Percentage (%)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Discount Value</label>
                            <input type="number" name="discountValue" value="" step="0.01" min="0" placeholder="0.00">
                            <small>Leave empty for no discount</small>
                        </div>
                        <div class="form-group">
                            <label>Stock Quantity</label>
                            <input type="number" name="inventory" value="0" step="1" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Weight (lbs)</label>
                            <input type="number" name="weight" value="" step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">Visibility</div>
                    <div class="form-group">
                        <label>Product Status</label>
                        <select name="visible">
                            <option value="TRUE" selected>✅ Visible (Show on store)</option>
                            <option value="FALSE">🔒 Hidden (Not visible to customers)</option>
                        </select>
                    </div>
                </div>
            `;

            document.getElementById('editModal').classList.add('active');
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                currentImageFile = file;
                document.getElementById('imageUrlInput').value = file.name;
                showNotification(`Image selected: ${file.name}`, 'info');
            }
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditIndex = null;
        }

        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            if (currentEditIndex === -1) {
                const newProduct = {};
                headers.forEach(header => {
                    newProduct[header] = formData.get(header) || '';
                });
                newProduct.syncStatus = 'pending';
                allProducts.push(newProduct);
            } else {
                const product = allProducts[currentEditIndex];
                formData.forEach((value, key) => {
                    product[key] = value;
                });
                product.syncStatus = 'pending';
            }

            closeModal();
            filterTable();
            updateStats();
        });

        async function deleteProduct(index) {
            const product = allProducts[index];

            if (!confirm(`Are you sure you want to delete "${product.name}"?\n\nThis will remove it from both the inventory and your Wix store.`)) {
                return;
            }

            // Delete from Wix if connected and product has a Wix ID
            if (wixConfig.connected && product.handleId && !product.handleId.startsWith('product_')) {
                try {
                    showNotification('Deleting from Wix...', 'info');
                    await callWixAPI(`/stores/v1/products/${product.handleId}`, 'DELETE');
                    console.log(`Deleted product from Wix: ${product.name} (${product.handleId})`);
                    showNotification('Product deleted from Wix and inventory', 'success');
                } catch (error) {
                    console.error('Wix deletion error:', error);
                    const proceed = confirm(`Failed to delete from Wix: ${error.message}\n\nDo you still want to remove it from the local inventory?`);
                    if (!proceed) {
                        return;
                    }
                    showNotification('Product removed from inventory only', 'info');
                }
            } else {
                showNotification('Product deleted from inventory', 'info');
            }

            // Remove from local inventory
            allProducts.splice(index, 1);
            selectedProducts.delete(index);
            filterTable();
            updateStats();
        }

        async function syncSingleProduct(index) {
            const product = allProducts[index];
            product.syncStatus = 'syncing';
            renderTable();

            const success = await syncProductToWix(product, index);
            renderTable();

            if (success) {
                showNotification('Product synced successfully', 'success');
                document.getElementById('lastSync').textContent = new Date().toLocaleTimeString();
            } else {
                showNotification('Sync failed: ' + (product.syncError || 'Unknown error'), 'error');
            }
        }

        // Import products from Wix
        async function importFromWix() {
            if (!wixConfig.connected) {
                showNotification('Please configure Wix API settings first', 'error');
                openWixSettings();
                return;
            }

            if (!confirm('This will replace your current inventory with products from Wix. Continue?')) {
                return;
            }

            const btn = document.getElementById('importWixBtn');
            btn.disabled = true;
            btn.textContent = 'Importing...';

            try {
                // First, fetch all collections to map IDs to names
                showNotification('Fetching categories...', 'info');
                const collectionsMap = {};

                try {
                    const collectionsResponse = await callWixAPI('/stores/v1/collections/query', 'POST', {
                        query: {
                            paging: { limit: 100 }
                        }
                    });

                    if (collectionsResponse.collections) {
                        collectionsResponse.collections.forEach(collection => {
                            collectionsMap[collection.id] = collection.name;
                        });
                        console.log('Categories loaded:', collectionsMap);
                    }
                } catch (error) {
                    console.error('Failed to fetch categories:', error);
                    // Continue without category names
                }

                let allWixProducts = [];
                let offset = 0;
                let hasMore = true;
                const limit = 100;

                showNotification('Fetching products from Wix...', 'info');

                // Fetch all products from Wix (paginated)
                while (hasMore) {
                    const query = {
                        query: {
                            paging: {
                                limit: limit,
                                offset: offset
                            },
                            // Include all product fields including price details
                            includeVariants: true
                        }
                    };

                    const response = await callWixAPI('/stores/v1/products/query', 'POST', query);

                    if (response.products && response.products.length > 0) {
                        allWixProducts = allWixProducts.concat(response.products);
                        offset += response.products.length;

                        // Update button with progress
                        btn.textContent = `Importing... (${allWixProducts.length} products)`;

                        // Check if there are more products
                        hasMore = response.products.length === limit;
                    } else {
                        hasMore = false;
                    }
                }

                // Convert Wix products to CSV format
                allProducts = allWixProducts.map((wixProduct, index) => {
                    // Debug: Log first product to see structure
                    if (index === 0) {
                        console.log('Sample Wix Product:', JSON.stringify(wixProduct, null, 2));
                        console.log('Price Data:', wixProduct.priceData);
                        console.log('Discount:', wixProduct.discount);
                    }

                    // Extract image URL - handle both full URLs and Wix media format
                    let imageUrl = '';
                    if (wixProduct.media?.mainMedia?.image?.url) {
                        const fullUrl = wixProduct.media.mainMedia.image.url;
                        // Extract just the filename/ID part after 'media/'
                        const match = fullUrl.match(/media\/([^?]+)/);
                        imageUrl = match ? match[1] : fullUrl.split('/').pop().split('?')[0];
                    } else if (wixProduct.media?.items?.[0]?.image?.url) {
                        const fullUrl = wixProduct.media.items[0].image.url;
                        const match = fullUrl.match(/media\/([^?]+)/);
                        imageUrl = match ? match[1] : fullUrl.split('/').pop().split('?')[0];
                    }

                    // Extract discount information - check multiple possible locations
                    let discountMode = 'AMOUNT';
                    let discountValue = '';

                    // Debug: Log price data for products with "Keep Evolving" in the name
                    if (wixProduct.name?.toLowerCase().includes('keep evolving')) {
                        console.log('=== Keep Evolving Product Found ===');
                        console.log('Full priceData:', JSON.stringify(wixProduct.priceData, null, 2));
                        console.log('Discount object:', JSON.stringify(wixProduct.discount, null, 2));
                    }

                    // Try all discount detection methods (not else-if, because formats vary)

                    // Method 1: Check explicit discount object first
                    if (wixProduct.discount && !discountValue) {
                        if (wixProduct.discount.type === 'PERCENT') {
                            discountMode = 'PERCENT';
                            discountValue = wixProduct.discount.value || '';
                            console.log(`✓ Product "${wixProduct.name}" has ${discountValue}% discount (from discount object)`);
                        } else if (wixProduct.discount.type === 'AMOUNT') {
                            discountMode = 'AMOUNT';
                            discountValue = wixProduct.discount.value || '';
                            console.log(`✓ Product "${wixProduct.name}" has $${discountValue} discount (from discount object)`);
                        }
                    }

                    // Method 2: Check direct priceData.discountedPrice (most common for sale prices)
                    if (!discountValue && wixProduct.priceData?.discountedPrice && wixProduct.priceData?.price) {
                        const originalPrice = parseFloat(wixProduct.priceData.price) || 0;
                        const discountedPrice = parseFloat(wixProduct.priceData.discountedPrice) || 0;

                        if (discountedPrice > 0 && discountedPrice < originalPrice) {
                            discountMode = 'AMOUNT';
                            discountValue = (originalPrice - discountedPrice).toFixed(2);
                            console.log(`✓ Product "${wixProduct.name}" has $${discountValue} discount (original: $${originalPrice}, sale: $${discountedPrice})`);
                        }
                    }

                    // Method 3: Check formatted prices
                    if (!discountValue && wixProduct.priceData?.formatted) {
                        const formattedPrice = wixProduct.priceData.formatted.price;
                        const formattedDiscounted = wixProduct.priceData.formatted.discountedPrice;

                        if (formattedDiscounted && formattedPrice) {
                            const originalPrice = parseFloat(wixProduct.priceData.price) || 0;
                            const discountedPrice = parseFloat(wixProduct.priceData.discountedPrice) || 0;

                            if (discountedPrice > 0 && discountedPrice < originalPrice) {
                                discountMode = 'AMOUNT';
                                discountValue = (originalPrice - discountedPrice).toFixed(2);
                                console.log(`✓ Product "${wixProduct.name}" has $${discountValue} discount (from formatted)`);
                            }
                        }
                    }

                    // Method 4: Check convertedPriceData for multi-currency stores
                    if (!discountValue && wixProduct.convertedPriceData?.discountedPrice && wixProduct.convertedPriceData?.price) {
                        const originalPrice = parseFloat(wixProduct.convertedPriceData.price) || 0;
                        const discountedPrice = parseFloat(wixProduct.convertedPriceData.discountedPrice) || 0;

                        if (discountedPrice > 0 && discountedPrice < originalPrice) {
                            discountMode = 'AMOUNT';
                            discountValue = (originalPrice - discountedPrice).toFixed(2);
                            console.log(`✓ Product "${wixProduct.name}" has $${discountValue} discount (from convertedPriceData)`);
                        }
                    }

                    // Get collection name from ID
                    let collectionName = '';
                    if (wixProduct.collectionIds && wixProduct.collectionIds.length > 0) {
                        const collectionId = wixProduct.collectionIds[0];
                        collectionName = collectionsMap[collectionId] || collectionId;
                    }

                    return {
                        handleId: wixProduct.id || `product_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        fieldType: 'Product',
                        name: wixProduct.name || '',
                        productImageUrl: imageUrl,
                        collection: collectionName,
                        sku: wixProduct.sku || '',
                        ribbon: wixProduct.ribbon || '',
                        price: wixProduct.priceData?.price || '0',
                        surcharge: '',
                        visible: wixProduct.visible ? 'TRUE' : 'FALSE',
                        discountMode: discountMode,
                        discountValue: discountValue,
                        inventory: wixProduct.stock?.quantity || '0',
                        weight: wixProduct.weight || '0',
                        cost: wixProduct.costAndProfitData?.itemCost || '',
                        productOptionName1: '',
                        productOptionType1: '',
                        productOptionDescription1: '',
                        productOptionName2: '',
                        productOptionType2: '',
                        productOptionDescription2: '',
                        productOptionName3: '',
                        productOptionType3: '',
                        productOptionDescription3: '',
                        productOptionName4: '',
                        productOptionType4: '',
                        productOptionDescription4: '',
                        productOptionName5: '',
                        productOptionType5: '',
                        productOptionDescription5: '',
                        productOptionName6: '',
                        productOptionType6: '',
                        productOptionDescription6: '',
                        additionalInfoTitle1: '',
                        additionalInfoDescription1: '',
                        additionalInfoTitle2: '',
                        additionalInfoDescription2: '',
                        additionalInfoTitle3: '',
                        additionalInfoDescription3: '',
                        additionalInfoTitle4: '',
                        additionalInfoDescription4: '',
                        additionalInfoTitle5: '',
                        additionalInfoDescription5: '',
                        additionalInfoTitle6: '',
                        additionalInfoDescription6: '',
                        customTextField1: '',
                        customTextCharLimit1: '',
                        customTextMandatory1: '',
                        customTextField2: '',
                        customTextCharLimit2: '',
                        customTextMandatory2: '',
                        brand: wixProduct.brand || 'Femi By Jojo',
                        syncStatus: 'synced'
                    };
                });

                // Update headers if not set
                if (headers.length === 0) {
                    headers = Object.keys(allProducts[0]);
                }

                populateFilters();
                filterTable();
                updateStats();

                showNotification(`Successfully imported ${allProducts.length} products from Wix!`, 'success');
                document.getElementById('fileName').textContent = `Imported from Wix (${allProducts.length} products)`;

            } catch (error) {
                console.error('Import error:', error);
                showNotification('Failed to import from Wix: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Import from Wix';
            }
        }

        function exportToCSV() {
            const csvContent = [
                headers.join(','),
                ...allProducts.map(product => {
                    return headers.map(header => {
                        const value = product[header] || '';
                        if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                            return '"' + value.replace(/"/g, '""') + '"';
                        }
                        return value;
                    }).join(',');
                })
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `catalog_products_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('CSV exported successfully', 'success');
        }

        window.addEventListener('DOMContentLoaded', function() {
            loadWixConfig();
            renderTable();
        });
    </script>
</body>
</html>
