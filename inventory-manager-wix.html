<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Femi By Jojo - Inventory Manager with Wix Sync</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f0f0f;
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #1a1a1a;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 1px solid #2a2a2a;
        }

        header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 2px solid #00d9ff;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #00d9ff, #00ffaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .wix-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(0, 217, 255, 0.1);
            border-radius: 20px;
            margin-top: 10px;
            cursor: pointer;
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-dot.connected {
            background: #00ffaa;
            box-shadow: 0 0 15px #00ffaa;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: rgba(0, 217, 255, 0.1);
            padding: 15px 25px;
            border-radius: 10px;
            border: 1px solid rgba(0, 217, 255, 0.2);
        }

        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #00d9ff;
        }

        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
            color: #a0a0a0;
        }

        .controls {
            padding: 30px;
            background: #1a1a1a;
            border-bottom: 1px solid #2a2a2a;
        }

        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        button {
            padding: 12px 24px;
            border: 1px solid #00d9ff;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #00d9ff, #00ffaa);
            color: #0f0f0f;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 217, 255, 0.5);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.wix-sync {
            background: linear-gradient(135deg, #00d9ff, #00ffaa);
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        input[type="text"],
        input[type="file"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: #252525;
            color: #e0e0e0;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #00d9ff;
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.2);
        }

        select {
            cursor: pointer;
            min-width: 150px;
        }

        
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #00d9ff;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            color: #00d9ff;
            cursor: pointer;
            white-space: nowrap;
        }

        th:hover {
            background: rgba(0, 217, 255, 0.1);
        }

        tbody tr {
            border-bottom: 1px solid #2a2a2a;
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: rgba(0, 217, 255, 0.05);
        }

        tbody tr.syncing {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        td {
            padding: 15px 10px;
            color: #e0e0e0;
        }

        td input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .product-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s ease;
            border: 2px solid #2a2a2a;
        }

        .product-image:hover {
            transform: scale(2);
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.3);
        }

        .price {
            font-weight: 600;
            color: #00d9ff;
        }

        .visible-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .visible-badge.visible-true {
            background: rgba(0, 255, 170, 0.2);
            color: #00ffaa;
            border: 1px solid rgba(0, 255, 170, 0.3);
        }

        .visible-badge.visible-false {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        .sync-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .sync-status.pending {
            background: rgba(160, 160, 160, 0.2);
            color: #a0a0a0;
            border: 1px solid rgba(160, 160, 160, 0.3);
        }

        .sync-status.syncing {
            background: rgba(0, 217, 255, 0.2);
            color: #00d9ff;
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        .sync-status.synced {
            background: rgba(0, 255, 170, 0.2);
            color: #00ffaa;
            border: 1px solid rgba(0, 255, 170, 0.3);
        }

        .sync-status.error {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        .edit-btn,
        .sync-btn,
        .delete-btn {
            padding: 6px 12px;
            margin-right: 5px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: #00d9ff;
            color: #0f0f0f;
            border: 1px solid #00d9ff;
        }

        .edit-btn:hover {
            background: #00c4e6;
            box-shadow: 0 4px 15px rgba(0, 217, 255, 0.4);
        }

        .sync-btn {
            background: #00ffaa;
            color: #0f0f0f;
            border: 1px solid #00ffaa;
        }

        .sync-btn:hover {
            background: #00e699;
            box-shadow: 0 4px 15px rgba(0, 255, 170, 0.4);
        }

        .delete-btn {
            background: #ff6b6b;
            color: white;
            border: 1px solid #ff6b6b;
        }

        .delete-btn:hover {
            background: #ff5252;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: #1a1a1a;
            border-top: 1px solid #2a2a2a;
        }

        .pagination button {
            padding: 8px 16px;
            background: #252525;
            border: 1px solid #2a2a2a;
            color: #e0e0e0;
        }

        .pagination button:hover:not(:disabled) {
            background: rgba(0, 217, 255, 0.2);
            border-color: #00d9ff;
        }

        .page-info {
            color: #a0a0a0;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 217, 255, 0.3);
            border: 1px solid #2a2a2a;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #00d9ff;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #a0a0a0;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .close-modal {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #3a3a3a;
        }

        .close-modal:hover {
            background: #3a3a3a;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 2000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            background: linear-gradient(135deg, #00ffaa, #00d9ff);
            color: #0f0f0f;
        }

        .notification.error {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
        }

        .notification.info {
            background: linear-gradient(135deg, #00d9ff, #00c4e6);
            color: #0f0f0f;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        #connectionLog {
            margin-top: 15px;
            padding: 15px;
            background: #252525;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            color: #a0a0a0;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #00d9ff;
            padding-left: 10px;
        }

        .log-entry.error {
            border-left-color: #ff6b6b;
            color: #ff6b6b;
        }

        .log-entry.success {
            border-left-color: #00ffaa;
            color: #00ffaa;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            height: 60px;
            width: auto;
            filter: brightness(0) invert(1);
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .header-center {
            flex: 1;
            text-align: center;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .header-left,
            .header-right {
                width: 100%;
                justify-content: center;
            }

            .header-center {
                order: -1;
            }
        }
    
        /* Enhanced Mobile Responsiveness */
        @media (max-width: 1024px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 12px;
            }

            header h1 {
                font-size: 2em;
            }

            .stat-card {
                padding: 12px 20px;
            }

            .stat-card .number {
                font-size: 1.5em;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                border-radius: 8px;
            }

            header {
                padding: 20px 15px;
            }

            header h1 {
                font-size: 1.5em;
            }

            .logo {
                height: 40px;
            }

            .header-content {
                gap: 15px;
            }

            .stats {
                gap: 15px;
            }

            .stat-card {
                padding: 10px 15px;
                min-width: 120px;
            }

            .stat-card .number {
                font-size: 1.3em;
            }

            .stat-card .label {
                font-size: 0.8em;
            }

            .controls {
                padding: 20px 15px;
            }

            .control-row {
                gap: 10px;
            }

            button {
                padding: 10px 18px;
                font-size: 13px;
                width: 100%;
            }

            .search-box {
                min-width: 100%;
            }

            select {
                width: 100%;
                min-width: 100%;
            }

            /* Table becomes horizontally scrollable on mobile */
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                font-size: 13px;
                min-width: 800px; /* Ensures table doesn't shrink too much */
            }

            th, td {
                padding: 10px 8px;
            }

            .product-image {
                width: 40px;
                height: 40px;
            }

            .edit-btn,
            .sync-btn,
            .delete-btn {
                padding: 5px 10px;
                font-size: 11px;
                margin-bottom: 3px;
                display: block;
                width: 100%;
            }

            .pagination {
                padding: 15px;
                gap: 10px;
            }

            .pagination button {
                padding: 8px 12px;
                font-size: 12px;
            }

            .page-info {
                font-size: 12px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
                max-height: 90vh;
            }

            .modal-content h2 {
                font-size: 1.5em;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 1.2em;
            }

            .logo {
                height: 35px;
            }

            .wix-status {
                padding: 8px 16px;
                font-size: 12px;
            }

            .stats {
                gap: 10px;
            }

            .stat-card {
                padding: 8px 12px;
                min-width: 100px;
            }

            .stat-card .number {
                font-size: 1.2em;
            }

            .stat-card .label {
                font-size: 0.75em;
            }

            button {
                padding: 10px 16px;
                font-size: 12px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 6px;
            }

            .product-image {
                width: 35px;
                height: 35px;
            }

            .notification {
                width: 90%;
                right: 5%;
                font-size: 13px;
                padding: 12px 18px;
            }
        }

        /* Landscape mobile orientation */
        @media (max-height: 600px) and (orientation: landscape) {
            header {
                padding: 15px;
            }

            .stats {
                margin-top: 10px;
            }

            .stat-card {
                padding: 8px 15px;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            button,
            .edit-btn,
            .sync-btn,
            .delete-btn {
                min-height: 44px; /* iOS recommended touch target */
            }

            input[type="checkbox"] {
                width: 24px;
                height: 24px;
            }

            .wix-status {
                min-height: 44px;
            }
        }

    
        /* Authentication Modal */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .auth-modal {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 25px 70px rgba(0, 217, 255, 0.4);
            border: 2px solid #00d9ff;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .auth-modal h2 {
            color: #00d9ff;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .auth-modal p {
            color: #a0a0a0;
            margin-bottom: 30px;
        }

        .auth-form .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .auth-form label {
            display: block;
            color: #00d9ff;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .auth-form input {
            width: 100%;
            padding: 14px;
            border: 2px solid #2a2a2a;
            border-radius: 10px;
            background: #252525;
            color: #e0e0e0;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .auth-form input:focus {
            outline: none;
            border-color: #00d9ff;
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.2);
        }

        .auth-form button {
            width: 100%;
            padding: 14px;
            margin-top: 10px;
            background: linear-gradient(135deg, #00d9ff, #00ffaa);
            border: none;
            border-radius: 10px;
            color: #0f0f0f;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.5);
        }

        .auth-error {
            color: #ff6b6b;
            margin-top: 15px;
            display: none;
            font-weight: 600;
        }

        .auth-logo {
            width: 120px;
            margin-bottom: 20px;
            filter: brightness(0) invert(1);
        }

    
        /* 2FA Specific Styles */
        .auth-step {
            display: none;
        }

        .auth-step.active {
            display: block;
        }

        .qr-code-container {
            text-align: center;
            margin: 20px 0;
        }

        .qr-code-container img {
            border: 3px solid #00d9ff;
            border-radius: 12px;
            padding: 10px;
            background: white;
            margin: 15px 0;
        }

        .secret-key {
            background: #252525;
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            color: #00d9ff;
            word-break: break-all;
            margin: 15px 0;
            border: 1px solid #2a2a2a;
        }

        .instructions {
            text-align: left;
            background: rgba(0, 217, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 3px solid #00d9ff;
        }

        .instructions ol {
            margin: 10px 0 10px 20px;
            color: #a0a0a0;
        }

        .instructions ol li {
            margin: 8px 0;
            line-height: 1.5;
        }

        .auth-form input[type="text"].code-input {
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            letter-spacing: 8px;
            font-family: monospace;
        }

        .auth-subtitle {
            color: #a0a0a0;
            margin: 10px 0;
            font-size: 14px;
        }

    </style>
</head>
<body>
    <!-- Authentication Modal -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <img src="https://static.wixstatic.com/media/ca757a_259168483bd74b31b0ca3ea1475b4ed3~mv2.png" alt="Femi By Jojo" class="auth-logo">
            <h2>Femi By Jojo</h2>
            <p>Inventory Manager - Secure Access</p>

            <!-- Step 1: Username & Password -->
            <div id="authStep1" class="auth-step active">
                <form class="auth-form" onsubmit="return checkPasswordAuth(event)">
                    <div class="form-group">
                        <label for="authUsername">Username</label>
                        <input type="text" id="authUsername" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="authPassword">Password</label>
                        <input type="password" id="authPassword" required autocomplete="current-password">
                    </div>
                    <button type="submit">Continue</button>
                    <div class="auth-error" id="authError">Invalid username or password</div>
                </form>
            </div>

            <!-- Step 2: 2FA Setup (First Time) -->
            <div id="authStep2Setup" class="auth-step">
                <p class="auth-subtitle">Set up Two-Factor Authentication</p>
                <div class="instructions">
                    <ol>
                        <li>Open Microsoft Authenticator on your phone</li>
                        <li>Tap the "+" button to add an account</li>
                        <li>Select "Other account (Google, Facebook, etc.)"</li>
                        <li>Scan the QR code below</li>
                        <li>Enter the 6-digit code shown in the app</li>
                    </ol>
                </div>
                <div class="qr-code-container">
                    <img id="qrCodeImage" src="" alt="QR Code">
                    <div class="secret-key">
                        <strong>Manual Entry Key:</strong><br>
                        <span id="secretKeyDisplay"></span>
                    </div>
                </div>
                <form class="auth-form" onsubmit="return verify2FASetup(event)">
                    <div class="form-group">
                        <label for="setup2FACode">Enter 6-Digit Code</label>
                        <input type="text" id="setup2FACode" class="code-input" maxlength="6" pattern="[0-9]{6}" required autocomplete="off">
                    </div>
                    <button type="submit">Verify & Complete Setup</button>
                    <div class="auth-error" id="setup2FAError">Invalid code. Please try again.</div>
                </form>
            </div>

            <!-- Step 3: 2FA Verification (Every Login) -->
            <div id="authStep3Verify" class="auth-step">
                <p class="auth-subtitle">Two-Factor Authentication Required</p>
                <div class="instructions">
                    <p style="color: #a0a0a0; text-align: center; padding: 10px;">
                        Open Microsoft Authenticator and enter the 6-digit code for <strong id="current2FAUser" style="color: #00d9ff;"></strong>
                    </p>
                </div>
                <form class="auth-form" onsubmit="return verify2FA(event)">
                    <div class="form-group">
                        <label for="verify2FACode">Enter 6-Digit Code</label>
                        <input type="text" id="verify2FACode" class="code-input" maxlength="6" pattern="[0-9]{6}" required autocomplete="off">
                    </div>
                    <button type="submit">Verify</button>
                    <div class="auth-error" id="verify2FAError">Invalid code. Please try again.</div>
                </form>
                <button class="close-modal" onclick="reset2FAFlow()" style="margin-top: 15px; width: 100%;">Back to Login</button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-left">
                    <img src="https://static.wixstatic.com/media/ca757a_259168483bd74b31b0ca3ea1475b4ed3~mv2.png" alt="Femi By Jojo Logo" class="logo">
                </div>
                <div class="header-center">
                    <h1>Inventory Manager</h1>
                </div>
                <div class="header-right">
                    <div class="wix-status" onclick="openWixSettings()">
                        <span class="status-dot" id="wixStatusDot"></span>
                        <span id="wixStatusText">Wix: Not Connected</span>
                    </div>
                </div>
            </div>
            <div class="stats">
                <div class="stat-card">
                    <div class="number" id="totalProducts">0</div>
                    <div class="label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="visibleProducts">0</div>
                    <div class="label">Visible Products</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="totalValue">$0</div>
                    <div class="label">Total Inventory Value</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="lastSync">Never</div>
                    <div class="label">Last Sync</div>
                </div>
            </div>
        </header>

        <div class="controls">
            <div class="control-row">
                <div class="file-upload">
                    <input type="file" id="csvFile" accept=".csv">
                    <label for="csvFile" class="file-label">Load CSV File</label>
                    <span id="fileName"></span>
                </div>
                <button class="wix-sync" onclick="importFromWix()" id="importWixBtn">Import from Wix</button>
                <button onclick="exportToCSV()">Export to CSV</button>
                <button onclick="addNewProduct()">Add New Product</button>
                <button class="wix-sync" onclick="syncAllToWix()" id="syncAllBtn">Sync All to Wix</button>
                <button class="wix-sync" onclick="syncSelectedToWix()" id="syncSelectedBtn">Sync Selected</button>
            </div>
            <div class="control-row">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search by name, SKU, category..." oninput="filterTable()">
                </div>
                <select id="collectionFilter" onchange="filterTable()">
                    <option value="">All Categories</option>
                </select>
                <select id="visibilityFilter" onchange="filterTable()">
                    <option value="">All Visibility</option>
                    <option value="TRUE">Visible Only</option>
                    <option value="FALSE">Hidden Only</option>
                </select>
                <select id="itemsPerPage" onchange="changeItemsPerPage()">
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                    <option value="all">Show All</option>
                </select>
            </div>
        </div>

        <div class="table-container">
            <table id="inventoryTable">
                <thead>
                    <tr id="tableHeader"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="pagination" id="pagination"></div>
    </div>

    <!-- Wix Settings Modal -->
    <div class="modal" id="wixSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Wix API Settings</h2>
                <button class="close-btn" onclick="closeWixSettings()">&times;</button>
            </div>
            <div class="form-group">
                <label>Wix Site ID</label>
                <input type="text" id="wixSiteId" placeholder="e.g., 12345678-abcd-1234-abcd-123456789abc">
                <small style="display: block; margin-top: 5px; color: #6c757d;">
                    Find this in your Wix Dashboard → Settings → Business Info
                </small>
            </div>
            <div class="form-group">
                <label>API Key</label>
                <input type="password" id="wixApiKey" placeholder="Your Wix API Key">
                <small style="display: block; margin-top: 5px; color: #6c757d;">
                    Get this from Wix Developers → API Keys
                </small>
            </div>
            <div class="form-group">
                <label>Account ID</label>
                <input type="text" id="wixAccountId" placeholder="Your Wix Account ID">
            </div>
            <div class="form-actions">
                <button type="button" onclick="closeWixSettings()" style="background: #6c757d;">Cancel</button>
                <button type="button" onclick="testWixConnection()">Test Connection</button>
                <button type="button" onclick="saveWixSettings()">Save Settings</button>
            </div>
            <div id="connectionLog" class="sync-log" style="margin-top: 20px; display: none;"></div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Edit Product</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="editForm">
                <div id="formFields"></div>
                <div class="form-actions">
                    <button type="button" onclick="closeModal()" style="background: #6c757d;">Cancel</button>
                    <button type="submit">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        let allProducts = [];
        let filteredProducts = [];
        let currentPage = 1;
        let itemsPerPage = 25;
        let sortColumn = null;
        let sortDirection = 'asc';
        let currentEditIndex = null;
        let headers = [];
        let selectedProducts = new Set();
        let wixConfig = {
            siteId: '',
            apiKey: '',
            accountId: '',
            connected: false
        };

        // API proxy URL - set this to your Vercel deployment URL
        const API_PROXY_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000/api/wix-proxy'
            : 'https://femibyjojo.vercel.app/api/wix-proxy';

        // Helper function to call Wix API through proxy
        async function callWixAPI(endpoint, method = 'GET', body = null) {
            const response = await fetch(API_PROXY_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    endpoint: endpoint,
                    method: method,
                    body: body,
                    headers: {
                        'authorization': wixConfig.apiKey,
                        'wix-site-id': wixConfig.siteId,
                        'wix-account-id': wixConfig.accountId
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || error.message || 'API request failed');
            }

            return await response.json();
        }

        // Load Wix config from localStorage
        function loadWixConfig() {
            const saved = localStorage.getItem('wixConfig');
            if (saved) {
                wixConfig = JSON.parse(saved);
                updateWixStatus();
            }
        }

        // Save Wix config to localStorage
        function saveWixConfig() {
            localStorage.setItem('wixConfig', JSON.stringify(wixConfig));
        }

        // Update Wix status display
        function updateWixStatus() {
            const dot = document.getElementById('wixStatusDot');
            const text = document.getElementById('wixStatusText');

            if (wixConfig.connected && wixConfig.siteId && wixConfig.apiKey) {
                dot.classList.add('connected');
                text.textContent = 'Wix: Connected';
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Wix: Not Connected';
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Open Wix settings
        function openWixSettings() {
            document.getElementById('wixSiteId').value = wixConfig.siteId || '';
            document.getElementById('wixApiKey').value = wixConfig.apiKey || '';
            document.getElementById('wixAccountId').value = wixConfig.accountId || '';
            document.getElementById('wixSettingsModal').classList.add('active');
        }

        // Close Wix settings
        function closeWixSettings() {
            document.getElementById('wixSettingsModal').classList.remove('active');
            document.getElementById('connectionLog').style.display = 'none';
        }

        // Test Wix connection
        async function testWixConnection() {
            const siteId = document.getElementById('wixSiteId').value.trim();
            const apiKey = document.getElementById('wixApiKey').value.trim();
            const accountId = document.getElementById('wixAccountId').value.trim();

            const log = document.getElementById('connectionLog');
            log.style.display = 'block';
            log.innerHTML = '<div class="log-entry info">Testing connection...</div>';

            if (!siteId || !apiKey || !accountId) {
                log.innerHTML += '<div class="log-entry error">Error: All fields are required</div>';
                return;
            }

            try {
                // Store credentials temporarily for test
                const tempConfig = {...wixConfig};
                wixConfig.siteId = siteId;
                wixConfig.apiKey = apiKey;
                wixConfig.accountId = accountId;

                // Test API connection through proxy
                const data = await callWixAPI('/stores/v1/products/query', 'POST', {
                    query: {
                        paging: { limit: 1 }
                    }
                });

                log.innerHTML += '<div class="log-entry success">✓ Connection successful!</div>';
                log.innerHTML += `<div class="log-entry info">Found ${data.totalResults || 0} products in your store</div>`;
                showNotification('Wix connection successful!', 'success');

                // Restore original config (will be saved when user clicks Save)
                wixConfig = tempConfig;
            } catch (error) {
                log.innerHTML += `<div class="log-entry error">✗ Connection error: ${error.message}</div>`;
                showNotification('Connection error: ' + error.message, 'error');
            }
        }

        // Save Wix settings
        function saveWixSettings() {
            wixConfig.siteId = document.getElementById('wixSiteId').value.trim();
            wixConfig.apiKey = document.getElementById('wixApiKey').value.trim();
            wixConfig.accountId = document.getElementById('wixAccountId').value.trim();
            wixConfig.connected = !!(wixConfig.siteId && wixConfig.apiKey && wixConfig.accountId);

            saveWixConfig();
            updateWixStatus();
            closeWixSettings();
            showNotification('Wix settings saved!', 'success');
        }

        // Upload image to Wix
        async function uploadImageToWix(file) {
            if (!file) return null;

            try {
                // Convert file to base64
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                // Upload to Wix Media Manager
                const uploadResult = await callWixAPI('/site-media/v1/files', 'POST', {
                    file: {
                        displayName: file.name,
                        mimeType: file.type,
                        url: `data:${file.type};base64,${base64}`
                    }
                });

                if (uploadResult && uploadResult.file && uploadResult.file.id) {
                    return uploadResult.file.id;
                }

                return null;
            } catch (error) {
                console.error('Image upload error:', error);
                throw new Error(`Failed to upload image: ${error.message}`);
            }
        }

        // Sync product to Wix
        async function syncProductToWix(product, index) {
            if (!wixConfig.connected) {
                showNotification('Please configure Wix API settings first', 'error');
                openWixSettings();
                return false;
            }

            try {
                // Upload image if a file was selected
                if (currentImageFile && index === currentEditIndex) {
                    showNotification('Uploading image...', 'info');
                    const imageId = await uploadImageToWix(currentImageFile);
                    if (imageId) {
                        product.productImageUrl = imageId;
                        currentImageFile = null;
                    }
                }

                // Map CSV product to Wix product format
                const wixProduct = {
                    name: product.name,
                    productType: 'physical',
                    priceData: {
                        price: parseFloat(product.price) || 0,
                        currency: 'USD'
                    },
                    stock: {
                        trackInventory: true,
                        quantity: parseInt(product.inventory) || 0
                    },
                    visible: product.visible === 'TRUE',
                    ribbon: product.ribbon || '',
                    description: product.description || ''
                };

                // Add discount if available
                if (product.discountValue && parseFloat(product.discountValue) > 0) {
                    const discountValue = parseFloat(product.discountValue);
                    if (product.discountMode === 'PERCENT') {
                        wixProduct.discount = {
                            type: 'PERCENT',
                            value: discountValue
                        };
                    } else {
                        wixProduct.discount = {
                            type: 'AMOUNT',
                            value: discountValue
                        };
                    }
                    console.log(`Setting discount: ${product.discountMode} ${discountValue}`);
                }

                // Add SKU if available
                if (product.sku) {
                    wixProduct.sku = product.sku;
                }

                // Add collection if available - handle both collection names and IDs
                if (product.collection) {
                    // If collection looks like an ID (UUID format), use it directly
                    // Otherwise, try to find collection by name or create it
                    if (product.collection.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)) {
                        wixProduct.collectionIds = [product.collection];
                    } else {
                        // Search for collection by name
                        try {
                            const collectionsResponse = await callWixAPI('/stores/v1/collections/query', 'POST', {
                                query: {
                                    filter: JSON.stringify({ name: product.collection })
                                }
                            });

                            if (collectionsResponse.collections && collectionsResponse.collections.length > 0) {
                                wixProduct.collectionIds = [collectionsResponse.collections[0].id];
                            } else {
                                // Create new collection if it doesn't exist
                                const newCollection = await callWixAPI('/stores/v1/collections', 'POST', {
                                    collection: {
                                        name: product.collection,
                                        visible: true
                                    }
                                });
                                if (newCollection.collection && newCollection.collection.id) {
                                    wixProduct.collectionIds = [newCollection.collection.id];
                                    console.log(`Created new category: ${product.collection} (${newCollection.collection.id})`);
                                }
                            }
                        } catch (error) {
                            console.error('Category handling error:', error);
                            // Continue without category if there's an error
                        }
                    }
                }

                // Add cost if available
                if (product.cost) {
                    wixProduct.costAndProfitData = {
                        itemCost: parseFloat(product.cost) || 0
                    };
                }

                // Add weight if available
                if (product.weight) {
                    wixProduct.weight = parseFloat(product.weight) || 0;
                }

                // Add product image if available
                if (product.productImageUrl) {
                    wixProduct.media = {
                        mainMedia: {
                            image: {
                                url: product.productImageUrl.startsWith('http')
                                    ? product.productImageUrl
                                    : `wix:image://v1/${product.productImageUrl}`
                            }
                        }
                    };
                }

                // Find existing product - check handleId first (contains Wix product ID), then SKU
                let productId = null;

                // Method 1: Check if handleId contains a Wix product ID (starts with alphanumeric pattern)
                if (product.handleId && !product.handleId.startsWith('product_') && product.handleId.length > 10) {
                    // handleId is likely a Wix product ID, verify it exists
                    try {
                        const existingProduct = await callWixAPI(`/stores/v1/products/${product.handleId}`, 'GET');
                        if (existingProduct && existingProduct.product) {
                            productId = product.handleId;
                            console.log(`Found existing product by ID: ${product.name} (${productId})`);
                        }
                    } catch (error) {
                        // Product ID not found, will try SKU search or create new
                        console.log(`Product ID ${product.handleId} not found, searching by SKU...`);
                    }
                }

                // Method 2: If not found by ID, search by SKU
                if (!productId && product.sku) {
                    const searchData = await callWixAPI('/stores/v1/products/query', 'POST', {
                        query: {
                            filter: JSON.stringify({ sku: product.sku })
                        }
                    });

                    if (searchData.products && searchData.products.length > 0) {
                        productId = searchData.products[0].id;
                        console.log(`Found existing product by SKU: ${product.name} (${productId})`);
                    }
                }

                // Update or create product
                if (productId) {
                    // Update existing product
                    console.log(`Updating product: ${product.name}`);
                    await callWixAPI(`/stores/v1/products/${productId}`, 'PATCH', { product: wixProduct });
                } else {
                    // Create new product
                    console.log(`Creating new product: ${product.name}`);
                    const result = await callWixAPI('/stores/v1/products', 'POST', { product: wixProduct });
                    // Update handleId with the new Wix product ID for future syncs
                    if (result.product && result.product.id) {
                        product.handleId = result.product.id;
                    }
                }

                product.syncStatus = 'synced';
                product.lastSyncTime = new Date().toISOString();
                return true;
            } catch (error) {
                console.error('Sync error:', error);
                product.syncStatus = 'error';
                product.syncError = error.message;
                return false;
            }
        }

        // Sync all products to Wix
        async function syncAllToWix() {
            if (!wixConfig.connected) {
                showNotification('Please configure Wix API settings first', 'error');
                openWixSettings();
                return;
            }

            if (!confirm(`Are you sure you want to sync all ${allProducts.length} products to Wix?`)) {
                return;
            }

            const btn = document.getElementById('syncAllBtn');
            btn.disabled = true;
            btn.textContent = 'Syncing...';

            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < allProducts.length; i++) {
                const product = allProducts[i];
                product.syncStatus = 'syncing';
                renderTable();

                const success = await syncProductToWix(product, i);
                if (success) {
                    successCount++;
                } else {
                    errorCount++;
                }

                renderTable();
            }

            btn.disabled = false;
            btn.textContent = 'Sync All to Wix';

            document.getElementById('lastSync').textContent = new Date().toLocaleTimeString();
            showNotification(`Sync complete: ${successCount} succeeded, ${errorCount} failed`, errorCount > 0 ? 'error' : 'success');
        }

        // Sync selected products
        async function syncSelectedToWix() {
            if (selectedProducts.size === 0) {
                showNotification('No products selected', 'info');
                return;
            }

            if (!wixConfig.connected) {
                showNotification('Please configure Wix API settings first', 'error');
                openWixSettings();
                return;
            }

            const btn = document.getElementById('syncSelectedBtn');
            btn.disabled = true;
            btn.textContent = 'Syncing...';

            let successCount = 0;
            let errorCount = 0;

            for (const index of selectedProducts) {
                const product = allProducts[index];
                product.syncStatus = 'syncing';
                renderTable();

                const success = await syncProductToWix(product, index);
                if (success) {
                    successCount++;
                } else {
                    errorCount++;
                }

                renderTable();
            }

            btn.disabled = false;
            btn.textContent = 'Sync Selected';

            document.getElementById('lastSync').textContent = new Date().toLocaleTimeString();
            showNotification(`Sync complete: ${successCount} succeeded, ${errorCount} failed`, errorCount > 0 ? 'error' : 'success');
        }

        // Toggle product selection
        function toggleProductSelection(index, checkbox) {
            if (checkbox.checked) {
                selectedProducts.add(index);
            } else {
                selectedProducts.delete(index);
            }
        }

        // Load CSV file
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseCSV(e.target.result);
                };
                reader.readAsText(file);
            }
        });

        // Parse CSV data
        function parseCSV(csv) {
            const lines = csv.split('\n');
            if (lines.length === 0) return;

            const firstLine = lines[0].replace(/^\ufeff/, '');
            headers = firstLine.split(',').map(h => h.trim());

            allProducts = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;

                const values = parseCSVLine(lines[i]);
                if (values.length > 0) {
                    const product = {};
                    headers.forEach((header, index) => {
                        product[header] = values[index] || '';
                    });
                    product.syncStatus = 'pending';
                    allProducts.push(product);
                }
            }

            populateFilters();
            filterTable();
            updateStats();
            renderTable();
            showNotification(`Loaded ${allProducts.length} products`, 'success');
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim());
            return values;
        }

        function populateFilters() {
            const collections = new Set();
            allProducts.forEach(product => {
                if (product.collection) {
                    collections.add(product.collection);
                }
            });

            const collectionFilter = document.getElementById('collectionFilter');
            collectionFilter.innerHTML = '<option value="">All Categories</option>';
            Array.from(collections).sort().forEach(collection => {
                const option = document.createElement('option');
                option.value = collection;
                option.textContent = collection;
                collectionFilter.appendChild(option);
            });
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const collectionFilter = document.getElementById('collectionFilter').value;
            const visibilityFilter = document.getElementById('visibilityFilter').value;

            filteredProducts = allProducts.filter(product => {
                const matchesSearch = !searchTerm ||
                    (product.name && product.name.toLowerCase().includes(searchTerm)) ||
                    (product.sku && product.sku.toLowerCase().includes(searchTerm)) ||
                    (product.collection && product.collection.toLowerCase().includes(searchTerm));

                const matchesCollection = !collectionFilter || product.collection === collectionFilter;
                const matchesVisibility = !visibilityFilter || product.visible === visibilityFilter;

                return matchesSearch && matchesCollection && matchesVisibility;
            });

            currentPage = 1;
            renderTable();
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            filteredProducts.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';

                if (column === 'price' || column === 'cost' || column === 'inventory' || column === 'weight') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            renderTable();
        }

        function renderTable() {
            if (allProducts.length === 0) {
                document.getElementById('tableHeader').innerHTML = '';
                document.getElementById('tableBody').innerHTML = `
                    <tr><td colspan="100" class="empty-state">
                        <h3>No products loaded</h3>
                        <p>Please load a CSV file to begin managing your inventory</p>
                    </td></tr>
                `;
                return;
            }

            const headerRow = document.getElementById('tableHeader');
            const displayColumns = ['select', 'productImageUrl', 'name', 'collection', 'sku', 'price', 'discountValue', 'salePrice', 'inventory', 'visible', 'syncStatus', 'actions'];
            const columnLabels = {
                'select': '☑',
                'productImageUrl': 'Image',
                'name': 'Product Name',
                'collection': 'Category',
                'sku': 'SKU',
                'price': 'Price',
                'discountValue': 'Discount',
                'salePrice': 'Sale Price',
                'inventory': 'Stock',
                'visible': 'Status',
                'syncStatus': 'Sync',
                'actions': 'Actions'
            };

            headerRow.innerHTML = displayColumns.map(col => {
                if (col === 'actions' || col === 'select' || col === 'syncStatus') {
                    return `<th>${columnLabels[col]}</th>`;
                }
                const sorted = sortColumn === col ? (sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc') : '';
                return `<th class="sortable ${sorted}" onclick="sortTable('${col}')">${columnLabels[col]}</th>`;
            }).join('');

            const start = itemsPerPage === 'all' ? 0 : (currentPage - 1) * itemsPerPage;
            const end = itemsPerPage === 'all' ? filteredProducts.length : start + itemsPerPage;
            const paginatedProducts = filteredProducts.slice(start, end);

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = paginatedProducts.map((product, index) => {
                const actualIndex = allProducts.indexOf(product);
                const imageUrl = product.productImageUrl ?
                    `https://static.wixstatic.com/media/${product.productImageUrl}` : '';

                const syncStatusClass = product.syncStatus || 'pending';
                const syncStatusText = {
                    'pending': 'Pending',
                    'syncing': 'Syncing...',
                    'synced': 'Synced',
                    'error': 'Error'
                }[syncStatusClass] || 'Unknown';

                // Format discount display and calculate sale price
                let discountDisplay = '-';
                let salePriceDisplay = '-';
                const basePrice = parseFloat(product.price || 0);

                if (product.discountValue && parseFloat(product.discountValue) > 0) {
                    const discountVal = parseFloat(product.discountValue);
                    let salePrice = basePrice;

                    if (product.discountMode === 'PERCENT') {
                        discountDisplay = `${discountVal}%`;
                        salePrice = basePrice - (basePrice * (discountVal / 100));
                    } else {
                        discountDisplay = `$${discountVal.toFixed(2)}`;
                        salePrice = basePrice - discountVal;
                    }

                    salePriceDisplay = `$${Math.max(0, salePrice).toFixed(2)}`;
                }

                return `
                    <tr class="${product.syncStatus === 'syncing' ? 'syncing' : ''}">
                        <td><input type="checkbox" onchange="toggleProductSelection(${actualIndex}, this)" ${selectedProducts.has(actualIndex) ? 'checked' : ''}></td>
                        <td>
                            ${imageUrl ? `<img src="${imageUrl}" class="product-image" alt="${product.name}" onclick="window.open('${imageUrl}', '_blank')">` : '-'}
                        </td>
                        <td><strong>${product.name || '-'}</strong></td>
                        <td>${product.collection || '-'}</td>
                        <td>${product.sku || '-'}</td>
                        <td class="price">$${basePrice.toFixed(2)}</td>
                        <td style="color: #e74c3c; font-weight: 500;">${discountDisplay}</td>
                        <td style="color: #27ae60; font-weight: 600; font-size: 1.05em;">${salePriceDisplay}</td>
                        <td>${product.inventory || 0}</td>
                        <td><span class="visible-badge visible-${product.visible?.toLowerCase()}">${product.visible === 'TRUE' ? 'Visible' : 'Hidden'}</span></td>
                        <td><span class="sync-status ${syncStatusClass}">${syncStatusText}</span></td>
                        <td>
                            <button class="edit-btn" onclick="editProduct(${actualIndex})">Edit</button>
                            <button class="sync-btn" onclick="syncSingleProduct(${actualIndex})">Sync</button>
                            <button class="delete-btn" onclick="deleteProduct(${actualIndex})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination();
        }

        function renderPagination() {
            if (itemsPerPage === 'all') {
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            const pagination = document.getElementById('pagination');

            pagination.innerHTML = `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                <span class="page-info">Page ${currentPage} of ${totalPages} (${filteredProducts.length} products)</span>
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
            `;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTable();
        }

        function changeItemsPerPage() {
            const value = document.getElementById('itemsPerPage').value;
            itemsPerPage = value === 'all' ? 'all' : parseInt(value);
            currentPage = 1;
            renderTable();
        }

        function updateStats() {
            document.getElementById('totalProducts').textContent = allProducts.length;

            const visibleCount = allProducts.filter(p => p.visible === 'TRUE').length;
            document.getElementById('visibleProducts').textContent = visibleCount;

            const totalValue = allProducts.reduce((sum, p) => {
                const price = parseFloat(p.price || 0);
                const inventory = parseInt(p.inventory || 0);
                return sum + (price * inventory);
            }, 0);
            document.getElementById('totalValue').textContent = '$' + totalValue.toFixed(2);
        }

        function editProduct(index) {
            currentEditIndex = index;
            currentImageFile = null;
            const product = allProducts[index];

            document.getElementById('modalTitle').textContent = 'Edit Product';

            const importantFields = ['name', 'productImageUrl', 'collection', 'sku', 'price', 'discountMode', 'discountValue', 'cost', 'inventory', 'visible', 'ribbon', 'weight', 'brand'];

            const formFields = document.getElementById('formFields');
            formFields.innerHTML = importantFields.map(field => {
                const value = product[field] || '';

                if (field === 'productImageUrl') {
                    return `
                        <div class="form-group">
                            <label>Product Image</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" name="${field}" id="imageUrlInput" value="${value}" placeholder="Image URL or filename" style="flex: 1;">
                                <input type="file" id="imageFileInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                                <button type="button" onclick="document.getElementById('imageFileInput').click()" style="background: #9b59b6; white-space: nowrap;">
                                    Choose Image
                                </button>
                            </div>
                            <small style="color: #888; font-size: 0.85em;">Upload an image or enter a URL/filename</small>
                        </div>
                    `;
                }

                if (field === 'discountMode') {
                    return `
                        <div class="form-group">
                            <label>Discount Type</label>
                            <select name="${field}">
                                <option value="AMOUNT" ${value === 'AMOUNT' || !value ? 'selected' : ''}>Fixed Amount ($)</option>
                                <option value="PERCENT" ${value === 'PERCENT' ? 'selected' : ''}>Percentage (%)</option>
                            </select>
                        </div>
                    `;
                }

                if (field === 'discountValue') {
                    return `
                        <div class="form-group">
                            <label>Discount Value</label>
                            <input type="number" name="${field}" value="${value}" step="0.01" min="0" placeholder="Enter discount amount or %">
                            <small style="color: #888; font-size: 0.85em;">Leave empty for no discount</small>
                        </div>
                    `;
                }

                if (field === 'visible') {
                    return `
                        <div class="form-group">
                            <label>${field}</label>
                            <select name="${field}">
                                <option value="TRUE" ${value === 'TRUE' ? 'selected' : ''}>Visible</option>
                                <option value="FALSE" ${value === 'FALSE' ? 'selected' : ''}>Hidden</option>
                            </select>
                        </div>
                    `;
                } else {
                    const inputType = ['price', 'cost', 'weight'].includes(field) ? 'number' :
                                     field === 'inventory' ? 'number' : 'text';
                    const step = ['price', 'cost', 'weight'].includes(field) ? '0.01' : '1';

                    return `
                        <div class="form-group">
                            <label>${field}</label>
                            <input type="${inputType}" name="${field}" value="${value}" ${inputType === 'number' ? `step="${step}"` : ''}>
                        </div>
                    `;
                }
            }).join('');

            document.getElementById('editModal').classList.add('active');
        }

        let currentImageFile = null;

        function addNewProduct() {
            currentEditIndex = -1;
            currentImageFile = null;
            document.getElementById('modalTitle').textContent = 'Add New Product';

            const newProduct = {
                handleId: `product_${Date.now()}`,
                fieldType: 'Product',
                name: '',
                productImageUrl: '',
                collection: '',
                sku: '',
                price: '',
                discountMode: 'AMOUNT',
                discountValue: '',
                cost: '',
                inventory: '0',
                visible: 'TRUE',
                ribbon: '',
                weight: '',
                brand: 'Femi By Jojo'
            };

            const formFields = document.getElementById('formFields');
            formFields.innerHTML = Object.keys(newProduct).map(field => {
                if (field === 'handleId' || field === 'fieldType') {
                    return `<input type="hidden" name="${field}" value="${newProduct[field]}">`;
                }

                if (field === 'productImageUrl') {
                    return `
                        <div class="form-group">
                            <label>Product Image</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" name="${field}" id="imageUrlInput" value="${newProduct[field]}" placeholder="Image URL or filename" style="flex: 1;">
                                <input type="file" id="imageFileInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                                <button type="button" onclick="document.getElementById('imageFileInput').click()" style="background: #9b59b6; white-space: nowrap;">
                                    Choose Image
                                </button>
                            </div>
                            <small style="color: #888; font-size: 0.85em;">Upload an image or enter a URL/filename</small>
                        </div>
                    `;
                }

                if (field === 'discountMode') {
                    return `
                        <div class="form-group">
                            <label>Discount Type</label>
                            <select name="${field}">
                                <option value="AMOUNT" selected>Fixed Amount ($)</option>
                                <option value="PERCENT">Percentage (%)</option>
                            </select>
                        </div>
                    `;
                }

                if (field === 'discountValue') {
                    return `
                        <div class="form-group">
                            <label>Discount Value</label>
                            <input type="number" name="${field}" value="${newProduct[field]}" step="0.01" min="0" placeholder="Enter discount amount or %">
                            <small style="color: #888; font-size: 0.85em;">Leave empty for no discount</small>
                        </div>
                    `;
                }

                if (field === 'visible') {
                    return `
                        <div class="form-group">
                            <label>${field}</label>
                            <select name="${field}">
                                <option value="TRUE" selected>Visible</option>
                                <option value="FALSE">Hidden</option>
                            </select>
                        </div>
                    `;
                } else {
                    const inputType = ['price', 'cost', 'weight'].includes(field) ? 'number' :
                                     field === 'inventory' ? 'number' : 'text';
                    const step = ['price', 'cost', 'weight'].includes(field) ? '0.01' : '1';

                    return `
                        <div class="form-group">
                            <label>${field}</label>
                            <input type="${inputType}" name="${field}" value="${newProduct[field]}" ${inputType === 'number' ? `step="${step}"` : ''}>
                        </div>
                    `;
                }
            }).join('');

            document.getElementById('editModal').classList.add('active');
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                currentImageFile = file;
                document.getElementById('imageUrlInput').value = file.name;
                showNotification(`Image selected: ${file.name}`, 'info');
            }
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditIndex = null;
        }

        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            if (currentEditIndex === -1) {
                const newProduct = {};
                headers.forEach(header => {
                    newProduct[header] = formData.get(header) || '';
                });
                newProduct.syncStatus = 'pending';
                allProducts.push(newProduct);
            } else {
                const product = allProducts[currentEditIndex];
                formData.forEach((value, key) => {
                    product[key] = value;
                });
                product.syncStatus = 'pending';
            }

            closeModal();
            filterTable();
            updateStats();
        });

        async function deleteProduct(index) {
            const product = allProducts[index];

            if (!confirm(`Are you sure you want to delete "${product.name}"?\n\nThis will remove it from both the inventory and your Wix store.`)) {
                return;
            }

            // Delete from Wix if connected and product has a Wix ID
            if (wixConfig.connected && product.handleId && !product.handleId.startsWith('product_')) {
                try {
                    showNotification('Deleting from Wix...', 'info');
                    await callWixAPI(`/stores/v1/products/${product.handleId}`, 'DELETE');
                    console.log(`Deleted product from Wix: ${product.name} (${product.handleId})`);
                    showNotification('Product deleted from Wix and inventory', 'success');
                } catch (error) {
                    console.error('Wix deletion error:', error);
                    const proceed = confirm(`Failed to delete from Wix: ${error.message}\n\nDo you still want to remove it from the local inventory?`);
                    if (!proceed) {
                        return;
                    }
                    showNotification('Product removed from inventory only', 'info');
                }
            } else {
                showNotification('Product deleted from inventory', 'info');
            }

            // Remove from local inventory
            allProducts.splice(index, 1);
            selectedProducts.delete(index);
            filterTable();
            updateStats();
        }

        async function syncSingleProduct(index) {
            const product = allProducts[index];
            product.syncStatus = 'syncing';
            renderTable();

            const success = await syncProductToWix(product, index);
            renderTable();

            if (success) {
                showNotification('Product synced successfully', 'success');
                document.getElementById('lastSync').textContent = new Date().toLocaleTimeString();
            } else {
                showNotification('Sync failed: ' + (product.syncError || 'Unknown error'), 'error');
            }
        }

        // Import products from Wix
        async function importFromWix(skipConfirm = false) {
            if (!wixConfig.connected) {
                showNotification('Please configure Wix API settings first', 'error');
                openWixSettings();
                return;
            }

            if (!skipConfirm && !confirm('This will replace your current inventory with products from Wix. Continue?')) {
                return;
            }

            const btn = document.getElementById('importWixBtn');
            btn.disabled = true;
            btn.textContent = 'Importing...';

            try {
                // First, fetch all collections to map IDs to names
                showNotification('Fetching categories...', 'info');
                const collectionsMap = {};

                try {
                    const collectionsResponse = await callWixAPI('/stores/v1/collections/query', 'POST', {
                        query: {
                            paging: { limit: 100 }
                        }
                    });

                    if (collectionsResponse.collections) {
                        collectionsResponse.collections.forEach(collection => {
                            collectionsMap[collection.id] = collection.name;
                        });
                        console.log('Categories loaded:', collectionsMap);
                    }
                } catch (error) {
                    console.error('Failed to fetch categories:', error);
                    // Continue without category names
                }

                let allWixProducts = [];
                let offset = 0;
                let hasMore = true;
                const limit = 100;

                showNotification('Fetching products from Wix...', 'info');

                // Fetch all products from Wix (paginated)
                while (hasMore) {
                    const query = {
                        query: {
                            paging: {
                                limit: limit,
                                offset: offset
                            },
                            // Include all product fields including price details
                            includeVariants: true
                        }
                    };

                    const response = await callWixAPI('/stores/v1/products/query', 'POST', query);

                    if (response.products && response.products.length > 0) {
                        allWixProducts = allWixProducts.concat(response.products);
                        offset += response.products.length;

                        // Update button with progress
                        btn.textContent = `Importing... (${allWixProducts.length} products)`;

                        // Check if there are more products
                        hasMore = response.products.length === limit;
                    } else {
                        hasMore = false;
                    }
                }

                // Convert Wix products to CSV format
                allProducts = allWixProducts.map((wixProduct, index) => {
                    // Debug: Log first product to see structure
                    if (index === 0) {
                        console.log('Sample Wix Product:', JSON.stringify(wixProduct, null, 2));
                        console.log('Price Data:', wixProduct.priceData);
                        console.log('Discount:', wixProduct.discount);
                    }

                    // Extract image URL - handle both full URLs and Wix media format
                    let imageUrl = '';
                    if (wixProduct.media?.mainMedia?.image?.url) {
                        const fullUrl = wixProduct.media.mainMedia.image.url;
                        // Extract just the filename/ID part after 'media/'
                        const match = fullUrl.match(/media\/([^?]+)/);
                        imageUrl = match ? match[1] : fullUrl.split('/').pop().split('?')[0];
                    } else if (wixProduct.media?.items?.[0]?.image?.url) {
                        const fullUrl = wixProduct.media.items[0].image.url;
                        const match = fullUrl.match(/media\/([^?]+)/);
                        imageUrl = match ? match[1] : fullUrl.split('/').pop().split('?')[0];
                    }

                    // Extract discount information - check multiple possible locations
                    let discountMode = 'AMOUNT';
                    let discountValue = '';

                    // Debug: Log price data for products with "Keep Evolving" in the name
                    if (wixProduct.name?.toLowerCase().includes('keep evolving')) {
                        console.log('=== Keep Evolving Product Found ===');
                        console.log('Full priceData:', JSON.stringify(wixProduct.priceData, null, 2));
                        console.log('Discount object:', JSON.stringify(wixProduct.discount, null, 2));
                    }

                    // Try all discount detection methods (not else-if, because formats vary)

                    // Method 1: Check explicit discount object first
                    if (wixProduct.discount && !discountValue) {
                        if (wixProduct.discount.type === 'PERCENT') {
                            discountMode = 'PERCENT';
                            discountValue = wixProduct.discount.value || '';
                            console.log(`✓ Product "${wixProduct.name}" has ${discountValue}% discount (from discount object)`);
                        } else if (wixProduct.discount.type === 'AMOUNT') {
                            discountMode = 'AMOUNT';
                            discountValue = wixProduct.discount.value || '';
                            console.log(`✓ Product "${wixProduct.name}" has $${discountValue} discount (from discount object)`);
                        }
                    }

                    // Method 2: Check direct priceData.discountedPrice (most common for sale prices)
                    if (!discountValue && wixProduct.priceData?.discountedPrice && wixProduct.priceData?.price) {
                        const originalPrice = parseFloat(wixProduct.priceData.price) || 0;
                        const discountedPrice = parseFloat(wixProduct.priceData.discountedPrice) || 0;

                        if (discountedPrice > 0 && discountedPrice < originalPrice) {
                            discountMode = 'AMOUNT';
                            discountValue = (originalPrice - discountedPrice).toFixed(2);
                            console.log(`✓ Product "${wixProduct.name}" has $${discountValue} discount (original: $${originalPrice}, sale: $${discountedPrice})`);
                        }
                    }

                    // Method 3: Check formatted prices
                    if (!discountValue && wixProduct.priceData?.formatted) {
                        const formattedPrice = wixProduct.priceData.formatted.price;
                        const formattedDiscounted = wixProduct.priceData.formatted.discountedPrice;

                        if (formattedDiscounted && formattedPrice) {
                            const originalPrice = parseFloat(wixProduct.priceData.price) || 0;
                            const discountedPrice = parseFloat(wixProduct.priceData.discountedPrice) || 0;

                            if (discountedPrice > 0 && discountedPrice < originalPrice) {
                                discountMode = 'AMOUNT';
                                discountValue = (originalPrice - discountedPrice).toFixed(2);
                                console.log(`✓ Product "${wixProduct.name}" has $${discountValue} discount (from formatted)`);
                            }
                        }
                    }

                    // Method 4: Check convertedPriceData for multi-currency stores
                    if (!discountValue && wixProduct.convertedPriceData?.discountedPrice && wixProduct.convertedPriceData?.price) {
                        const originalPrice = parseFloat(wixProduct.convertedPriceData.price) || 0;
                        const discountedPrice = parseFloat(wixProduct.convertedPriceData.discountedPrice) || 0;

                        if (discountedPrice > 0 && discountedPrice < originalPrice) {
                            discountMode = 'AMOUNT';
                            discountValue = (originalPrice - discountedPrice).toFixed(2);
                            console.log(`✓ Product "${wixProduct.name}" has $${discountValue} discount (from convertedPriceData)`);
                        }
                    }

                    // Get collection name from ID
                    let collectionName = '';
                    if (wixProduct.collectionIds && wixProduct.collectionIds.length > 0) {
                        const collectionId = wixProduct.collectionIds[0];
                        collectionName = collectionsMap[collectionId] || collectionId;
                    }

                    return {
                        handleId: wixProduct.id || `product_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        fieldType: 'Product',
                        name: wixProduct.name || '',
                        productImageUrl: imageUrl,
                        collection: collectionName,
                        sku: wixProduct.sku || '',
                        ribbon: wixProduct.ribbon || '',
                        price: wixProduct.priceData?.price || '0',
                        surcharge: '',
                        visible: wixProduct.visible ? 'TRUE' : 'FALSE',
                        discountMode: discountMode,
                        discountValue: discountValue,
                        inventory: wixProduct.stock?.quantity || '0',
                        weight: wixProduct.weight || '0',
                        cost: wixProduct.costAndProfitData?.itemCost || '',
                        productOptionName1: '',
                        productOptionType1: '',
                        productOptionDescription1: '',
                        productOptionName2: '',
                        productOptionType2: '',
                        productOptionDescription2: '',
                        productOptionName3: '',
                        productOptionType3: '',
                        productOptionDescription3: '',
                        productOptionName4: '',
                        productOptionType4: '',
                        productOptionDescription4: '',
                        productOptionName5: '',
                        productOptionType5: '',
                        productOptionDescription5: '',
                        productOptionName6: '',
                        productOptionType6: '',
                        productOptionDescription6: '',
                        additionalInfoTitle1: '',
                        additionalInfoDescription1: '',
                        additionalInfoTitle2: '',
                        additionalInfoDescription2: '',
                        additionalInfoTitle3: '',
                        additionalInfoDescription3: '',
                        additionalInfoTitle4: '',
                        additionalInfoDescription4: '',
                        additionalInfoTitle5: '',
                        additionalInfoDescription5: '',
                        additionalInfoTitle6: '',
                        additionalInfoDescription6: '',
                        customTextField1: '',
                        customTextCharLimit1: '',
                        customTextMandatory1: '',
                        customTextField2: '',
                        customTextCharLimit2: '',
                        customTextMandatory2: '',
                        brand: wixProduct.brand || 'Femi By Jojo',
                        syncStatus: 'synced'
                    };
                });

                // Update headers if not set
                if (headers.length === 0) {
                    headers = Object.keys(allProducts[0]);
                }

                populateFilters();
                filterTable();
                updateStats();

                showNotification(`Successfully imported ${allProducts.length} products from Wix!`, 'success');
                document.getElementById('fileName').textContent = `Imported from Wix (${allProducts.length} products)`;

            } catch (error) {
                console.error('Import error:', error);
                showNotification('Failed to import from Wix: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Import from Wix';
            }
        }

        function exportToCSV() {
            const csvContent = [
                headers.join(','),
                ...allProducts.map(product => {
                    return headers.map(header => {
                        const value = product[header] || '';
                        if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                            return '"' + value.replace(/"/g, '""') + '"';
                        }
                        return value;
                    }).join(',');
                })
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `catalog_products_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('CSV exported successfully', 'success');
        }

        window.addEventListener('DOMContentLoaded', async function() {
            loadWixConfig();
            renderTable();

            // Debug: Check Wix config status
            console.log('Wix Config:', {
                connected: wixConfig.connected,
                hasSiteId: !!wixConfig.siteId,
                hasApiKey: !!wixConfig.apiKey,
                hasAccountId: !!wixConfig.accountId
            });

            // Auto-import from Wix if connected
            if (wixConfig.connected && wixConfig.siteId && wixConfig.apiKey && wixConfig.accountId) {
                console.log('Auto-importing from Wix...');
                showNotification('Auto-importing products from Wix...', 'info');

                // Wait a moment for the UI to render
                setTimeout(async () => {
                    try {
                        await importFromWix(true);
                    } catch (error) {
                        console.error('Auto-import failed:', error);
                        showNotification('Auto-import failed. Click "Import from Wix" to try again.', 'error');
                    }
                }, 500);
            }
        });
    

        
        // ==================== TOTP 2FA Implementation ====================

        // Base32 encoding/decoding for TOTP secrets
        const base32 = {
            charset: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567',

            encode: function(buffer) {
                let bits = 0;
                let value = 0;
                let output = '';

                for (let i = 0; i < buffer.length; i++) {
                    value = (value << 8) | buffer[i];
                    bits += 8;

                    while (bits >= 5) {
                        output += this.charset[(value >>> (bits - 5)) & 31];
                        bits -= 5;
                    }
                }

                if (bits > 0) {
                    output += this.charset[(value << (5 - bits)) & 31];
                }

                return output;
            },

            decode: function(str) {
                let bits = 0;
                let value = 0;
                let index = 0;
                const output = new Uint8Array(Math.ceil(str.length * 5 / 8));

                for (let i = 0; i < str.length; i++) {
                    const idx = this.charset.indexOf(str[i].toUpperCase());
                    if (idx === -1) continue;

                    value = (value << 5) | idx;
                    bits += 5;

                    if (bits >= 8) {
                        output[index++] = (value >>> (bits - 8)) & 255;
                        bits -= 8;
                    }
                }

                return output;
            }
        };

        // HMAC-SHA1 implementation
        function hmacSHA1(key, message) {
            const blockSize = 64;

            if (key.length > blockSize) {
                key = sha1(key);
            }

            const keyPadded = new Uint8Array(blockSize);
            keyPadded.set(key);

            const ipad = new Uint8Array(blockSize);
            const opad = new Uint8Array(blockSize);

            for (let i = 0; i < blockSize; i++) {
                ipad[i] = keyPadded[i] ^ 0x36;
                opad[i] = keyPadded[i] ^ 0x5c;
            }

            const innerHash = sha1(concat(ipad, message));
            return sha1(concat(opad, innerHash));
        }

        function sha1(data) {
            const msg = new Uint8Array(data);
            const msgLen = msg.length;
            const bitLen = msgLen * 8;

            const paddedLen = Math.ceil((msgLen + 9) / 64) * 64;
            const padded = new Uint8Array(paddedLen);
            padded.set(msg);
            padded[msgLen] = 0x80;

            const view = new DataView(padded.buffer);
            view.setUint32(paddedLen - 4, bitLen, false);

            let h0 = 0x67452301;
            let h1 = 0xEFCDAB89;
            let h2 = 0x98BADCFE;
            let h3 = 0x10325476;
            let h4 = 0xC3D2E1F0;

            for (let offset = 0; offset < paddedLen; offset += 64) {
                const w = new Array(80);

                for (let i = 0; i < 16; i++) {
                    w[i] = view.getUint32(offset + i * 4, false);
                }

                for (let i = 16; i < 80; i++) {
                    w[i] = rotl(w[i-3] ^ w[i-8] ^ w[i-14] ^ w[i-16], 1);
                }

                let a = h0, b = h1, c = h2, d = h3, e = h4;

                for (let i = 0; i < 80; i++) {
                    let f, k;
                    if (i < 20) {
                        f = (b & c) | ((~b) & d);
                        k = 0x5A827999;
                    } else if (i < 40) {
                        f = b ^ c ^ d;
                        k = 0x6ED9EBA1;
                    } else if (i < 60) {
                        f = (b & c) | (b & d) | (c & d);
                        k = 0x8F1BBCDC;
                    } else {
                        f = b ^ c ^ d;
                        k = 0xCA62C1D6;
                    }

                    const temp = (rotl(a, 5) + f + e + k + w[i]) | 0;
                    e = d;
                    d = c;
                    c = rotl(b, 30);
                    b = a;
                    a = temp;
                }

                h0 = (h0 + a) | 0;
                h1 = (h1 + b) | 0;
                h2 = (h2 + c) | 0;
                h3 = (h3 + d) | 0;
                h4 = (h4 + e) | 0;
            }

            const result = new Uint8Array(20);
            const resultView = new DataView(result.buffer);
            resultView.setUint32(0, h0, false);
            resultView.setUint32(4, h1, false);
            resultView.setUint32(8, h2, false);
            resultView.setUint32(12, h3, false);
            resultView.setUint32(16, h4, false);

            return result;
        }

        function rotl(n, s) {
            return (n << s) | (n >>> (32 - s));
        }

        function concat(a, b) {
            const result = new Uint8Array(a.length + b.length);
            result.set(a);
            result.set(b, a.length);
            return result;
        }

        // Generate TOTP code
        function generateTOTP(secret, timeStep = 30) {
            const epoch = Math.floor(Date.now() / 1000);
            const counter = Math.floor(epoch / timeStep);

            const key = base32.decode(secret);
            const message = new Uint8Array(8);
            const view = new DataView(message.buffer);
            view.setUint32(4, counter, false);

            const hash = hmacSHA1(key, message);
            const offset = hash[19] & 0xf;
            const binary = ((hash[offset] & 0x7f) << 24) |
                          ((hash[offset + 1] & 0xff) << 16) |
                          ((hash[offset + 2] & 0xff) << 8) |
                          (hash[offset + 3] & 0xff);

            const otp = binary % 1000000;
            return otp.toString().padStart(6, '0');
        }

        // Generate random secret for new 2FA setup
        function generateSecret() {
            const buffer = new Uint8Array(20);
            crypto.getRandomValues(buffer);
            return base32.encode(buffer);
        }

        // Generate QR code URL for Microsoft Authenticator
        function generateQRCodeURL(username, secret) {
            const issuer = 'Femi By Jojo';
            const accountName = username + '@FemiByJojo';
            const otpauth = 'otpauth://totp/' + encodeURIComponent(issuer + ':' + accountName) +
                          '?secret=' + secret +
                          '&issuer=' + encodeURIComponent(issuer) +
                          '&algorithm=SHA1&digits=6&period=30';

            // Use Google Charts API to generate QR code
            return 'https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=' + encodeURIComponent(otpauth);
        }

        // Get or create 2FA secret for user
        function get2FASecret(username) {
            const secrets = JSON.parse(localStorage.getItem('totp_secrets') || '{}');

            if (!secrets[username]) {
                secrets[username] = generateSecret();
                localStorage.setItem('totp_secrets', JSON.stringify(secrets));
            }

            return secrets[username];
        }

        // Check if user has completed 2FA setup
        function is2FASetup(username) {
            const setupComplete = JSON.parse(localStorage.getItem('totp_setup_complete') || '{}');
            return setupComplete[username] === true;
        }

        // Mark 2FA setup as complete
        function complete2FASetup(username) {
            const setupComplete = JSON.parse(localStorage.getItem('totp_setup_complete') || '{}');
            setupComplete[username] = true;
            localStorage.setItem('totp_setup_complete', JSON.stringify(setupComplete));
        }

        // Validate TOTP code (with time window tolerance)
        function validateTOTP(secret, userCode) {
            // Check current time window and +/- 1 window for clock drift tolerance
            for (let drift = -1; drift <= 1; drift++) {
                const epoch = Math.floor(Date.now() / 1000) + (drift * 30);
                const counter = Math.floor(epoch / 30);

                const key = base32.decode(secret);
                const message = new Uint8Array(8);
                const view = new DataView(message.buffer);
                view.setUint32(4, counter, false);

                const hash = hmacSHA1(key, message);
                const offset = hash[19] & 0xf;
                const binary = ((hash[offset] & 0x7f) << 24) |
                              ((hash[offset + 1] & 0xff) << 16) |
                              ((hash[offset + 2] & 0xff) << 8) |
                              (hash[offset + 3] & 0xff);

                const otp = (binary % 1000000).toString().padStart(6, '0');

                if (otp === userCode) {
                    return true;
                }
            }

            return false;
        }

        // ==================== End TOTP Implementation ====================

        // Authentication System
        const AUTH_CREDENTIALS = [
            { username: 'admin', passwordHash: '2eb9771b', requires2FA: true },
            { username: 'Jojo', passwordHash: '29c5f3e4', requires2FA: true },
            { username: 'zooman', passwordHash: '2eb9769f', requires2FA: true }
        ];

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        let currentAuthUser = null;
        let currentAuthUsername = null;

        function checkPasswordAuth(event) {
            event.preventDefault();

            const username = document.getElementById('authUsername').value;
            const password = document.getElementById('authPassword').value;
            const passwordHash = simpleHash(password);

            // Check if credentials match any user
            const validUser = AUTH_CREDENTIALS.find(user =>
                user.username === username && user.passwordHash === passwordHash
            );

            if (validUser) {
                currentAuthUser = validUser;
                currentAuthUsername = username;

                // Check if 2FA is required
                if (validUser.requires2FA) {
                    // Check if user has completed 2FA setup
                    if (is2FASetup(username)) {
                        // Show 2FA verification step
                        show2FAVerification(username);
                    } else {
                        // Show 2FA setup step
                        show2FASetup(username);
                    }
                } else {
                    // No 2FA required, grant access
                    grantAccess(username);
                }

                // Hide error
                document.getElementById('authError').style.display = 'none';
            } else {
                document.getElementById('authError').style.display = 'block';
                document.getElementById('authPassword').value = '';
            }

            return false;
        }

        function show2FASetup(username) {
            // Hide step 1, show step 2
            document.getElementById('authStep1').classList.remove('active');
            document.getElementById('authStep2Setup').classList.add('active');

            // Generate secret and QR code
            const secret = get2FASecret(username);
            const qrURL = generateQRCodeURL(username, secret);

            document.getElementById('qrCodeImage').src = qrURL;
            document.getElementById('secretKeyDisplay').textContent = secret;
            document.getElementById('setup2FACode').value = '';
            document.getElementById('setup2FAError').style.display = 'none';
        }

        function show2FAVerification(username) {
            // Hide step 1, show step 3
            document.getElementById('authStep1').classList.remove('active');
            document.getElementById('authStep3Verify').classList.add('active');

            document.getElementById('current2FAUser').textContent = username;
            document.getElementById('verify2FACode').value = '';
            document.getElementById('verify2FAError').style.display = 'none';

            // Auto-focus the code input
            setTimeout(() => {
                document.getElementById('verify2FACode').focus();
            }, 100);
        }

        function verify2FASetup(event) {
            event.preventDefault();

            const code = document.getElementById('setup2FACode').value;
            const secret = get2FASecret(currentAuthUsername);

            if (validateTOTP(secret, code)) {
                // Mark 2FA setup as complete
                complete2FASetup(currentAuthUsername);

                // Grant access
                grantAccess(currentAuthUsername);

                showNotification('2FA setup completed successfully!', 'success');
            } else {
                document.getElementById('setup2FAError').style.display = 'block';
                document.getElementById('setup2FACode').value = '';
            }

            return false;
        }

        function verify2FA(event) {
            event.preventDefault();

            const code = document.getElementById('verify2FACode').value;
            const secret = get2FASecret(currentAuthUsername);

            if (validateTOTP(secret, code)) {
                // Grant access
                grantAccess(currentAuthUsername);
            } else {
                document.getElementById('verify2FAError').style.display = 'block';
                document.getElementById('verify2FACode').value = '';
            }

            return false;
        }

        function grantAccess(username) {
            // Store authentication in session
            sessionStorage.setItem('authenticated', 'true');
            sessionStorage.setItem('username', username);

            // Hide auth overlay
            document.getElementById('authOverlay').style.display = 'none';

            // Reset to step 1 for next login
            reset2FAFlow();

            showNotification('Login successful! Welcome back, ' + username + '.', 'success');
        }

        function reset2FAFlow() {
            // Show step 1, hide others
            document.getElementById('authStep1').classList.add('active');
            document.getElementById('authStep2Setup').classList.remove('active');
            document.getElementById('authStep3Verify').classList.remove('active');

            // Clear form fields
            document.getElementById('authUsername').value = '';
            document.getElementById('authPassword').value = '';
            document.getElementById('authError').style.display = 'none';

            currentAuthUser = null;
            currentAuthUsername = null;
        }

        // Check authentication on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Check if already authenticated in this session
            if (sessionStorage.getItem('authenticated') === 'true') {
                document.getElementById('authOverlay').style.display = 'none';
            }
        });

    </script>
</body>
</html>
